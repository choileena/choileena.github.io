---
title: "Pro-Med-Str - Part I"
description: |
  This tutorial describes how to processes structured medication data, especially focusing on intravenously given dose data.
output:
  distill::distill_article:
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(R.options = list(width = 120))
library(EHR)
```

* See also "Pro-Med-Str Part I: IV dose data" in "[2. EHR Vignette for Structured Data](https://cran.r-project.org/web/packages/EHR/vignettes/ehr_vignette_02_str.html)" of `EHR` package.

# Introduction

This tutorial describes how to use the *Pro-Med-Str* - Part II module in *EHRtoPKPD* system to process intravenous (IV) dose data (see Choi *et al.*$^{1}$ for details).

To begin we load the `EHR` package,

```{r load-lib-dir, eval=FALSE}
# load EHR package
library(EHR)
```

# Input raw dose data

We will use example dose data to demonstrate the *Pro-Med-Str Part I* module. The raw data is shown below.

```{r}
mar.in0 <- read.csv(system.file("examples", "str_ex2","MAR_DATA.csv", package="EHR"), check.names = FALSE)
head(mar.in0)
```

This data consists of a patient ID, date, time, medication name, dosage, route, frequency, and medication given.

The patient ID may need to be renamed so that all input datasets have the same name for the patient ID. This is necessary when combining the datasets to create a crosswalk between the original ID variables and the new ID variables used in the *Pro-Med-Str Part I* module. See "[2. EHR Vignette for Structured Data](https://cran.r-project.org/web/packages/EHR/vignettes/ehr_vignette_02_str.html)" of the `EHR` package for more information. We demonstrate how to rename the patient ID variable below.


```{r}
mar.new <- dataTransformation(mar.in0, rename = c('Uniq.Id' = 'mod_id'))
```

# Preparing Raw Dose Data for the *Pro-Med-Str Part I* Module

In practice, the dose data will need to be combined with other input datasets. This process involves creating a crosswalk between original ID variables and new ID variables. The new ID variables that are required to be the same across all datasets are `mod_id`, `mod_visit`, and `mod_id_visit`. See "[2. EHR Vignette for Structured Data](https://cran.r-project.org/web/packages/EHR/vignettes/ehr_vignette_02_str.html)" of `EHR` package and "[Build-PK-IV - Comprehensive Workshop](https://choileena.github.io/Build-PK-IV-comprehensive.html)" for examples of this process.

For simplicity, we will skip this step in this tutorial.

We need to save our dataset as an RDS file using `saveRDS` as shown below. Here, we create a temporary directory to store the file using `tempdir` to define two directories, `dataDir` for processed data and `checkDir` containing files used for interactive checking (optional); however, `dataDir` and `checkDir` can be a specific directory on your computer.

```{r}
# define 2 directories
td <- tempdir()
dataDir <- file.path(td, 'data') # directory for processed data
dir.create(dataDir)
checkDir <- file.path(td, 'checks') # directory for interactive checking
dir.create(checkDir)
saveRDS(mar.new, file=file.path(dataDir,"mar_new.rds"))
```

The next section demonstrates how to use the `run_MedStrI` function to run the *Pro-Med-Str* module.

# Running `run_MedStrI()`

* IV dose data can be in various forms, which may need to be pre-processed. IV dose data can be obtained from different data sources when using electronic health records (EHRs), but we illustrate this module using an example dataset that comes from one data source for simplicity (see "[Build-PK-IV - Comprehensive Workshop](https://choileena.github.io/Build-PK-IV-comprehensive.html)" for a case when dose data are obtained from two data sources).

* `run_MedStrI()` is the main function to process IV dose data in *Pro-Med-Str* Part I module
* The module can be semi-interactive -- it generates several files to check potential data errors and get feedback from an investigator. If corrected information ('fix' files) are provided, the module should be re-run to incorporate the corrections. 

* The following arguments must be specified:
    + `flow.path`: file path where Flow data exist
    + `flow.select`: list of variables in the Flow data, which are used for processing
    + `flow.rename`: rename variables for the variables in flow.select
    + `flow.mod.list`: list containing modifications to variables in the Flow data
    + `medchk.path`: file path with list of medication names and variants in MAR data to be used 
    + `mar.path`: file path where the MAR data exist
    + `demo.list`: (optional) demographic data, produced from Pro-Demographic, that can be used to impute weight when missing
    + `check.path`: file path where the generated files for data checking are stored, and the corresponding data files with fixed data exist
    + `failflow_fn`: filename stub for invalid duplicate rows in the Flow data with rate of 0 check file. The stub will be prepended with the string 'fail' to create a .csv with the invalid data. The corrected data with failures replaced should use the same filename stub prepended with the string 'fix'.
         - e.g., if `failflow_fn` is 'FailFlow', the file 'failFailFlow.csv' with invalid duplicate rows will be created in the directory specified by `check.path`. The corrected version named 'fixFailFlow.csv' should be placed in the same directory.
    + `failunit_fn`: filename stub for records with units other than those specified with `infusion.unit` and `bolus.unit`
    + `failnowgt_fn`: filename stub for records with missing weight in the Flow data and unit involving 'kg'
    + `infusion.unit`: string specifying units for infusion doses (default: 'mcg/kg/hr')
    + `bolus.unit`: string specifying units for bolus doses (default: 'mcg')
    + `bol.rate.thresh`: upper bound for retaining bolus doses. Bolus units with a rate above the threshold are dropped (default: Inf; i.e., keep all bolus doses)
    + `drugname`: drug name of interest (e.g., dex, fent)

Below we show how we would run `run_MedStrI()` using the cleaned dose dataset, "mar_new.rds", as input.

```{r Pro-Med-Str1}
# define parameters
drugname <- 'fent'

ivdose.out <- run_MedStrI(
    flow.path=NULL,
    flow.select = c('mod_id','mod_id_visit','Perform.Date','Final.Wt..kg.',
                    'Final.Rate..NFR.units.','Final.Units'),
    flow.rename = c('mod_id','mod_id_visit', 'Perform.Date', 'weight',
                    'rate', 'final.units'),
    flow.mod.list = list(
      date.time =
    expression(pkdata::parse_dates(fixDates(Perform.Date))), unit =
    expression(sub(".*[ ]", "", rate)), rate = expression(as.numeric(sub("([0-9.]+).*",
    "\\1", rate)))),
    mar.path=file.path(dataDir,"mar_new.rds"),
    mar.datetimeCol = c('Date', 'Time'),
    mar.doseCol = 'med:dosage',
    mar.drugCol = 'med:mDrug',
    mar.weightCol = NULL,
    mar.givenCol = NULL,
    medGivenReq = TRUE,
    medchk.path=file.path(system.file("examples", "str_ex2", package="EHR"), sprintf('medChecked-%s.csv', drugname)),
    demo.list=NULL,
    missing.wgt.path = NULL,
    check.path=checkDir, 
    failflow_fn = 'FailFlow',
    failunit_fn = 'Unit',
    failnowgt_fn = 'NoWgt',
    infusion.unit = 'mcg/kg/hr',
    bolus.unit = 'mcg',
    bol.rate.thresh = Inf,
    rateunit = "mcg/hr",
    ratewgtunit = "mcg/kg/hr",
    weightunit = "kg",
    drugname = drugname
    )
```

# Output of `run_MedStrI()`

```{r}
head(ivdose.out)
```

* The output from the *Pro-Med-Str* - Part I module is a `data.frame` with XXX columns:  

  - `mod_id`: the new id that will be used to merge datasets.
  - `infuse.time.real`: infusion dose time. (NEED??: date.dose,  infuse.time, given dose)
  - `infuse.dose`: infusion dose.  
  - `bolus.time`: bolus dose time.
  - `bolus.dose`: bolus dose.
  - `maxint`: IV infusion interval.
  - `weight`: subject body weight.

This output is the input of `run_Build_PK_IV()` function in *Build-PK-IV* module. In the above output, all variables except `maxint` and `weight` are the necessary variables that should be reserved to use `run_Build_PK_IV()`.

# References
1. Choi L, Beck C, McNeer E, Weeks HL, Williams ML, James NT, Niu X, Abou-Khalil BW, Birdwell KA, Roden DM, Stein CM. Development of a System for Post-marketing Population Pharmacokinetic and Pharmacodynamic Studies using Real-World Data from Electronic Health Records. Clinical Pharmacology & Therapeutics. 2020 Apr;107(4):934-43. doi: 10.1002/cpt.1787.

