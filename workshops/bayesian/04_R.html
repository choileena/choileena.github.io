<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta property="og:title" content="Become a Bayesian with R &amp; Stan" />
<meta property="og:type" content="book" />


<meta property="og:description" content="An introduction to using R for Bayesian data analysis." />
<meta name="github-repo" content="m-clark/Workshops" />


<meta name="date" content="2016-12-11" />

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>
  <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_CHTML-full" type="text/javascript"></script>

<meta name="description" content="An introduction to using R for Bayesian data analysis.">

<title>Become a Bayesian with R &amp; Stan</title>

<link href="libs/tufte-css-2015.12.29/tufte.css" rel="stylesheet" />


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>


<link rel="stylesheet" href="toc_test.css" type="text/css" />
<link rel="stylesheet" href="notebooks.css" type="text/css" />

</head>

<body>



<div class="row">
<div class="col-sm-12">
<div id="TOC">
<ul>
<li><a href="index.html#home"><span style="color:transparent">Home</span></a></li>
<li class="has-sub"><a href="01_intro.html#introduction">Introduction</a><ul>
<li><a href="01_intro.html#outline">Outline</a></li>
<li><a href="01_intro.html#prerequisites">Prerequisites</a></li>
</ul></li>
<li class="has-sub"><a href="02_key_concepts.html#key-concepts">Key Concepts</a><ul>
<li><a href="02_key_concepts.html#distributions">Distributions</a></li>
<li><a href="02_key_concepts.html#prior">Prior</a></li>
<li><a href="02_key_concepts.html#likelihood">Likelihood</a></li>
<li><a href="02_key_concepts.html#posterior">Posterior</a></li>
<li><a href="02_key_concepts.html#p-values">P-values</a></li>
</ul></li>
<li class="has-sub"><a href="03_stan.html#stan">Stan</a><ul>
<li><a href="03_stan.html#installing-stan">Installing Stan</a></li>
<li><a href="03_stan.html#the-way-of-stanrstan">The Way of Stan/RStan</a></li>
<li class="has-sub"><a href="03_stan.html#elements-of-a-stan-program">Elements of a Stan Program</a><ul>
<li><a href="03_stan.html#data">Data</a></li>
<li><a href="03_stan.html#transformed-data">Transformed Data</a></li>
<li><a href="03_stan.html#parameters">Parameters</a></li>
<li><a href="03_stan.html#transformed-parameters">Transformed Parameters</a></li>
<li><a href="03_stan.html#model">Model</a></li>
<li><a href="03_stan.html#generated-quantities">Generated Quantities</a></li>
</ul></li>
<li><a href="03_stan.html#using-stan">Using Stan</a></li>
</ul></li>
<li class="has-sub"><a href="04_R.html#r">R</a><ul>
<li class="has-sub"><a href="04_R.html#rstan">rstan</a><ul>
<li><a href="04_R.html#data-list">Data list</a></li>
<li><a href="04_R.html#debug-model">Debug model</a></li>
<li><a href="04_R.html#full-model">Full model</a></li>
<li><a href="04_R.html#model-summary">Model summary</a></li>
<li><a href="04_R.html#diagnostics-and-beyond">Diagnostics and beyond</a></li>
</ul></li>
<li><a href="04_R.html#rstanarm">rstanarm</a></li>
<li><a href="04_R.html#brms">brms</a></li>
<li><a href="04_R.html#rethinking">rethinking</a></li>
<li><a href="04_R.html#summary">Summary</a></li>
</ul></li>
<li class="has-sub"><a href="05_extensions.html#extensions">Extensions</a><ul>
<li><a href="05_extensions.html#r-1">R</a></li>
<li><a href="05_extensions.html#stan-functions">Stan functions</a></li>
<li><a href="05_extensions.html#other-frameworks">Other frameworks</a></li>
</ul></li>
<li><a href="1000_Conclusion.html#conclusion">Conclusion</a></li>
<li><a href="1001_references.html#references">References</a></li>
</ul>
</div>
</div>
</div>
<div class="row">
<div class="col-sm-12">
<div id="r" class="section level1">
<h1>R</h1>
<p>R has many tools for Bayesian analysis, and possessed these before Stan came around. Among the more prominent were those that allowed the use of BUGS (e.g. <span class="pack">r2OpenBugs</span>), one of its dialects JAGS (<span class="pack">rjags</span>), and packages like <span class="pack">coda</span> and <span class="pack">MCMCpack</span> that allowed for customized approaches, further extensions or easier implementation. Other packages might regard a specific type or family of models (e.g. <span class="pack">bayesm</span>), but otherwise be mostly R-like in specifying the model (e.g. <span class="pack">MCMCglmm</span> for mixed models).</p>
<p>Now it is as easy to conduct standard and more complex models using Stan while staying within the usual framework of R-style modeling. You don’t even have to write Stan code! I’ll later note a couple relevant packages that enable this.</p>
<div id="rstan" class="section level2">
<h2>rstan</h2>
<p>The <span class="pack">rstan</span> package is the workhorse, and the other packages mentioned in following rely on it or assume similarities to it. In general though, <span class="pack">rstan</span> is what you will use when you write Stan code directly. The following demonstrates how.</p>
<div id="data-list" class="section level3">
<h3>Data list</h3>
<p>First you’ll need to create a list of objects we’ll call the <span class="emph">data list</span>. It is a list of <em>named</em> objects that Stan will look to match to the things you noted in the <code>data{}</code> section of your Stan code. In our example, our data statement has four components- <code>N</code> <code>K</code> <code>X</code> and <code>y</code>. As such, we might create the following data list.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dataList =<span class="st">  </span><span class="kw">list</span>(<span class="dt">X=</span>mymatrix, <span class="dt">y=</span>mytarget, <span class="dt">N=</span><span class="dv">1000</span>, <span class="dt">K=</span><span class="kw">ncol</span>(mymatrix))</code></pre></div>
<p>You could add fixed parameters and similar if your Stan code relies on them somewhere, but at this point you’re ready to proceed. Here is a model using RStan.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(rstan)

modResults =<span class="st"> </span><span class="kw">stan</span>(mystancode, <span class="dt">data=</span>dataList, <span class="dt">iter=</span><span class="dv">2000</span>, <span class="dt">warmup=</span><span class="dv">1000</span>)</code></pre></div>
<p>The Stan code is specified as noted previously, and can be a string in the R environment, or a separate text file<label for="tufte-sn-7" class="margin-toggle sidenote-number">7</label><input type="checkbox" id="tufte-sn-7" class="margin-toggle"><span class="sidenote"><span class="sidenote-number">7</span> I would maybe suggest using strings with simple models as you initially learn Stan/RStan, but a separate file is preferred. RStudio has syntax highlighting and other benefits for *.stan files.</span>.</p>
</div>
<div id="debug-model" class="section level3">
<h3>Debug model</h3>
<p>The debug model is just like any other except you’ll only want a couple iterations and for one chain.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">model_debug =<span class="st"> </span><span class="kw">stan</span>(mystancode, <span class="dt">data=</span>dataList, <span class="dt">iter=</span><span class="dv">10</span>, <span class="dt">chains=</span><span class="dv">1</span>)</code></pre></div>
<p>This will allow you to make sure the Stan code compiles first and foremost, and secondly, that there aren’t errors in the program that keep parameters from being estimated (thus resulting in no posterior samples). For a compile check, you hardly need any iterations. However, if you set the iterations a little higher, you may also discover potential difficulties in the estimation process that might suggest code issues remain.</p>
</div>
<div id="full-model" class="section level3">
<h3>Full model</h3>
<p>If all is well with the previous, you can now proceed with the main model. Setting the argument <code>fit = debugModel</code> will save you the time spent compiling. It is a notable time saver to run the chains in parallel by setting <code>cores = ncore</code>, where <code>ncore</code> is some value representing the number of cores on your machine you want to use.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mystanmodel =<span class="st"> </span><span class="kw">stan</span>(mystancode, <span class="dt">data=</span>dataList, <span class="dt">fit =</span> model_debug, 
                   <span class="dt">iter=</span><span class="dv">2000</span>, <span class="dt">warmup=</span><span class="dv">1000</span>, <span class="dt">thin=</span><span class="dv">1</span>, <span class="dt">chains=</span><span class="dv">4</span>, <span class="dt">cores=</span><span class="dv">4</span>)</code></pre></div>
<p>Once you are satisfied that the model runs well, you really only need one chain if you rerun it in the future.</p>
</div>
<div id="model-summary" class="section level3">
<h3>Model summary</h3>
<p>The typical model summary provides parameter estimates, standard errors, interval estimates and two diagnostics- effective sample size, the <span class="math inline">\(\hat{R}\)</span> diagnostic.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(mystanmodel, <span class="dt">pars=</span><span class="kw">c</span>(<span class="st">&#39;Intercept&#39;</span>, <span class="st">&#39;beta_1&#39;</span>, <span class="st">&#39;sigma&#39;</span>, <span class="st">&#39;Rsq&#39;</span>), <span class="dt">probs =</span> <span class="kw">c</span>(.<span class="dv">05</span>,.<span class="dv">95</span>), <span class="dt">digits=</span><span class="dv">3</span>)</code></pre></div>
<pre><code>Inference for Stan model: 34b5bc624f3e17e6f88e764a5bc0c898.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

           mean se_mean    sd     5%   95% n_eff  Rhat
Intercept 1.267   0.002 0.085  1.126 1.403  1396 1.004
beta_1    0.081   0.004 0.148 -0.157 0.331  1606 1.003
sigma     0.969   0.001 0.030  0.922 1.019  2313 0.999
Rsq       0.646   0.000 0.001  0.644 0.648  1816 1.002

Samples were drawn using NUTS(diag_e) at Wed Nov 09 15:32:08 2016.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
<div id="diagnostics-and-beyond" class="section level3">
<h3>Diagnostics and beyond</h3>
<p>Typical Bayesian diagnostic tools like trace plots, density plots etc. are available. Part of the printed output contains the two just mentioned. In addition <span class="pack">rstan</span> comes with model comparison functions like <span class="func">WAIC</span> and <span class="func">loo</span>. The best part is the <span class="func">launch_shiny</span> function, which actually makes this part of the analysis a lot more fun. Below is a graphical depiction of what would open in your browser when you use the function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(shinystan)
<span class="kw">launch_shiny</span>(mystanmodel)</code></pre></div>
<p><img src="img/shinystan.png" style="display:block; margin: 0 auto;"></p>
</div>
</div>
<div id="rstanarm" class="section level2">
<h2>rstanarm</h2>
<p>The <span class="pack">rstanarm</span> is a package from the Stan developers that allows you to specify models in the standard R format<label for="tufte-mn-2" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-2" class="margin-toggle"><span class="marginnote">The ‘arm’ in rstanarm is for ‘applied regression and multilevel modeling’, which is <em>NOT</em> the title of Gelman’s book no matter what he says.</span>. While this is very limiting, it definitely covers a lot of the usual statistical ground. As such, it enables you to be a Bayesian for any of the very common glm settings, including mixed and additive models.</p>
<p>Key modeling functions include:</p>
<ul>
<li><span class="func">stan_lm</span>: as with lm</li>
<li><span class="func">stan_glm</span>: as with glm</li>
<li><span class="func">stan_glmer</span>: generalized linear mixed models</li>
<li><span class="func">stan_gamm4</span>: generalized additive mixed models</li>
<li><span class="func">stan_polr</span>: ordinal regression models</li>
</ul>
<p>Other functions allow the ability to change priors, enable posterior predictive checking etc. The following shows example code.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(rstanarm)

rstanarm_results =<span class="st"> </span><span class="kw">stan_glm</span>(y ~<span class="st"> </span>x, <span class="dt">data=</span>mydataframe, <span class="dt">iter=</span><span class="dv">2000</span>, <span class="dt">warmup=</span><span class="dv">1000</span>, <span class="dt">cores=</span><span class="dv">4</span>)
<span class="kw">summary</span>(rstanarm_results, <span class="dt">probs=</span><span class="kw">c</span>(.<span class="dv">025</span>, .<span class="dv">975</span>), <span class="dt">digits=</span><span class="dv">3</span>)</code></pre></div>
<pre><code>stan_glm(formula = y ~ x, data = mydataframe, iter = 2000, warmup = 1000)

Family: gaussian (identity)
Algorithm: sampling
Posterior sample size: 4000
Observations: 500

Estimates:
                mean     sd       2.5%     97.5% 
(Intercept)      1.272    0.086    1.101    1.441
x                0.071    0.148   -0.216    0.364
sigma            0.969    0.030    0.912    1.030
mean_PPD         1.309    0.060    1.189    1.426
log-posterior -700.510    1.131 -703.489 -699.217

Diagnostics:
              mcse  Rhat  n_eff
(Intercept)   0.001 1.000 3298 
x             0.003 0.999 3364 
sigma         0.001 0.999 3428 
mean_PPD      0.001 1.000 3553 
log-posterior 0.022 1.001 2598 

For each parameter, mcse is Monte Carlo standard error, n_eff is a crude measure of effective sample size, and Rhat is the potential scale reduction factor on split chains (at convergence Rhat=1).</code></pre>
<p>The resulting model object can essentially be used just like the <span class="func">lm</span>/<span class="func">glm</span> functions in base R. There are <span class="func">summary</span>, <span class="func">predict</span>, <span class="func">fitted</span>, <span class="func">coef</span> etc. functions available to use just like with standard model objects.</p>
</div>
<div id="brms" class="section level2">
<h2>brms</h2>
<p>I have watched with much enjoyment the development of the <span class="pack">brms</span> package from nearly its inception. Due to the continued development of <span class="pack">rstanarm</span>, it’s role is becoming more niche perhaps, but I still believe it to be both useful and powerful. It allows for many types of models, custom Stan functions, and many distributions (including truncated versions, ordinal variables, zero-inflated, etc.). The main developer is ridiculously responsive to requests, so extensions are regularly implemented. In short, for standard models you can use <span class="pack">rstanarm</span>, while for variations of those, more flexible manipulation of priors, or more complex models, you can use <span class="pack">brms</span>.</p>
<p>The following shows an example of the additional capabilities provided by the <span class="func">brm</span> function, which unlike rstanarm, is the only function you need for modeling with this package. The following demonstrates use of a truncated distribution, an additive model with random effect, use of a different family function, specification of prior distribution for the fixed effect coefficients, specification of correlated residual structure, optional estimation algorithm, and use of custom Stan functions.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(brms)

modResults =<span class="st"> </span><span class="kw">brm</span>(y |<span class="st"> </span><span class="kw">trunc</span>(<span class="dt">lb =</span> <span class="dv">0</span>, <span class="dt">ub =</span> <span class="dv">100</span>) ~<span class="st"> </span><span class="kw">s</span>(x) +<span class="st"> </span>(<span class="dv">1</span>|id), <span class="dt">family=</span>student, <span class="dt">data=</span>dataList, 
                 <span class="dt">prior =</span> <span class="kw">set_prior</span>(<span class="st">&#39;horseshoe(3)&#39;</span>, <span class="dt">class=</span><span class="st">&#39;b&#39;</span>),
                 <span class="dt">autocor =</span> <span class="kw">cor_ar</span>(~patient, <span class="dt">p =</span> <span class="dv">1</span>),
                 <span class="dt">algorithm =</span> <span class="st">&#39;meanfield&#39;</span>,
                 <span class="dt">stan_funs =</span> stdized,
                 <span class="dt">iter=</span><span class="dv">2000</span>, <span class="dt">warmup=</span><span class="dv">1000</span>)</code></pre></div>
<p>The <span class="pack">brms</span> package also has a lot of the same functionality for post model inspection.</p>
</div>
<div id="rethinking" class="section level2">
<h2>rethinking</h2>
<p>The <span class="pack">rethinking</span> package accompanies the text, Statistical Rethinking by Richard McElreath. This is a great resource for learning Bayesian data analysis while using Stan under the hood. You can do more with the other packages mentioned, but if you can also run your model here, you might get even more to play with. Like <span class="pack">rstanarm</span> and <span class="pack">brms</span>, you might be able to use it to produce starter Stan code as well, that you can then manipulate and use via <span class="pack">rstan</span>. Again, this is a very useful tool to learn Bayesian analysis in general, especially if you have the text.</p>
</div>
<div id="summary" class="section level2">
<h2>Summary</h2>
<p>To recap, we can summarize the roles of these packages as follows (ordered from easiest to more flexible):</p>
<ul>
<li><p><span class="pack">rethinking</span>: Good resource to introduce yourself to Bayesian analysis.</p></li>
<li><p><span class="pack">rstanarm</span>: All you need to start on your path to using Bayesian techniques. Keeps you in more familiar modeling territory so you can focus on learning the new stuff. Supports up through mixed models, GAMs, and ordinal models.</p></li>
<li><p><span class="pack">brms</span>: Take your model notably further and still not have to write raw stan code. Supports a very wide range of models and still without raw Stan code.</p></li>
<li><p><span class="pack">rstan</span>: Here you write your Stan code regarding whatever model your heart desires, then let rstan do the rest.</p></li>
<li><p>raw R or other: Some still insist on writing their own sampler. While great for learning purposes, this is mostly a good way to produce buggier code, have less model exploration capability, all while being a lot less efficient (and very slow if in raw R). Maybe you’ll end up here, but you should exhaust your other possibilities first.</p></li>
</ul>

</div>
</div>
<p style="text-align: center;">
<a href="03_stan.html"><button class="btn btn-default">Previous</button></a>
<a href="05_extensions.html"><button class="btn btn-default">Next</button></a>
</p>
</div>
</div>



</body>
</html>
