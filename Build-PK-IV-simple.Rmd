---
title: "Build-PK-IV - Simple"
description: |
  This lecture describes a simple pharmacokinetic data building procedure without using additional data processing modules for medications that are intravenously administered.
author:
  - name: Nathan T. James, Leena Choi
output:
  distill::distill_article:
    toc: true
    toc_depth: 1
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(EHR)
library(pkdata)
library(lubridate)
```

# Introduction
This lecture describes a simple pharmacokinetic (PK) data building procedure in *EHRtoPKPD* for medications that are intravenously (IV) administered. It demonstrates how to quickly build PK data using *Build-PK-IV* when cleaned data for concentration, drug dose, demographic and laboratory datasets are available in the appropriate data format. A comprehensive PK data building procedure with *Build-PK-IV* for IV medications that requires several data processing modules is described in [*Build-PK-IV* - Comprehensive](Build-PK-IV-comprehensive.html) (see Choi *et al.*$^{1}$ for details).

To begin we load the `EHR` package, the `pkdata` package, and the `lubridate` package. 

```{r load-lib-dir, eval=FALSE}
# load EHR package and dependencies
library(EHR)
library(pkdata)
library(lubridate)
```

# Quick Data Building with Processed Datasets

We first define a directory for the raw data and a directory for interactive checking output files.
The data includes a demographic file, a drug concentration file, an IV dosing file, and a laboratory file, which are all cleaned and formatted appropriately. 

```{r simp-in}
# define directories
rawDataDir <- system.file("examples", "str_ex1", package="EHR")
td <- tempdir()
dir.create(file.path(td, 'check1'))
checkDir <- file.path(td, 'check1')

# read in data
demo <- read.csv(file.path(rawDataDir,"Demographics_DATA_simple.csv"),stringsAsFactors = FALSE)
head(demo)
conc.data <- read.csv(file.path(rawDataDir,"Concentration_DATA_simple.csv"),stringsAsFactors = FALSE)
head(conc.data)
ivdose.data <- read.csv(file.path(rawDataDir,"IVDose_DATA_simple.csv"),stringsAsFactors = FALSE)
head(ivdose.data)
creat.data <- read.csv(file.path(rawDataDir,"Creatinine_DATA_simple.csv"),stringsAsFactors = FALSE)
head(creat.data)
```

The `EHR` package modules use a standardized naming convention for patient identification (ID) variables. We rename the unique patient-level ID from `patient_id` to `mod_id` and the visit-level ID from `patient_visit_id` to `mod_id_visit`. If there is only a single visit/course per subject the unique patient-level ID and visit-level ID can be the same, however both `mod_id` and `mod_id_visit` should be defined.

```{r simp-rename}
names(conc.data)[1:2] <- names(demo)[1:2] <- c("mod_id", "mod_id_visit")
names(creat.data)[1] <- names(ivdose.data)[1] <- "mod_id"
```

<!--
```{r simp-mods}
demo.data <- list(demo=demo, exclude=NULL)
creat.data$date.time <- lubridate::ymd_hms(creat.data$date.time)
```

```{r simp-xwalk}
mod_id <- demo[,c("mod_id", "mod_id_visit")]
pat_id <- mod_id
names(pat_id) <- c("patient_id","patient_visit_id")
xwalk1 <- cbind(mod_id, pat_id)
options(pkxwalk = 'xwalk1')
```
-->

Using the four datasets, we can build a final PK dataset with the function `run_Build_PK_IV()`.

```{r sim-build-pk-iv}
simple_pk_dat <- run_Build_PK_IV(
    conc=conc.data,
    dose=ivdose.data,
    lab.dat = list(creat.data),
    lab.vars = c('creat'),
    demo.list = demo,
    demo.vars=c('weight', 'weight_demo', 'height', 'gender', 'ageatsurgery',
                'stat_sts', 'cpb_sts', 'length_of_icu_stay'),
    demo.abbr=c('wgt', 'wgt_demo', 'height', 'gender',
                'age', 'stat', 'cpb', 'loi'),
    pk.vars=c('mod_id_visit', 'time', 'conc', 'dose', 'rate', 'event',
              'other', 'multiple.record', 'date', 'mod_id'),
    drugname='fent',
    check.path=checkDir)
```

```{r sim-build-pk-iv-out}
head(simple_pk_dat,15)
```


### References

1. Choi L, Beck C, McNeer E, Weeks HL, Williams ML, James NT, Niu X, Abou-Khalil BW, Birdwell KA, Roden DM, Stein CM. Development of a System for Post-marketing Population Pharmacokinetic and Pharmacodynamic Studies using Real-World Data from Electronic Health Records. Clinical Pharmacology & Therapeutics. 2020 Apr; 107(4): 934-943.  

