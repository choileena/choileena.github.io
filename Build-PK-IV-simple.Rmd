---
title: "Build-PK-IV - Simple"
description: |
  This tutorial describes a simple pharmacokinetic data building procedure without using additional data processing modules for medications that are intravenously administered.
author:
  - name: Nathan T. James, Leena Choi
output:
  distill::distill_article:
    toc: true
    toc_depth: 2
---

**Under construction**

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(EHR)
library(pkdata)
library(lubridate)
```

* See also "Example 1: Quick Data Building with Processed Datasets" in "[2. EHR Vignette for Structured Data](https://cran.r-project.org/web/packages/EHR/vignettes/ehr_vignette_02_str.html)" of `EHR` package.

# Introduction
This tutorial describes a simple pharmacokinetic (PK) data building procedure in *EHRtoPKPD* for medications that are intravenously (IV) administered. It demonstrates how to quickly build PK data using *Build-PK-IV* when cleaned data for concentration, drug dose, demographic and laboratory datasets are available in the appropriate data format. A comprehensive PK data building procedure with *Build-PK-IV* for IV medications that requires several data processing modules is described in [*Build-PK-IV* - Comprehensive](Build-PK-IV-comprehensive.html) (see Choi *et al.*$^{1}$ for details).

To begin we load the `EHR` package, the `pkdata` package, and the `lubridate` package. 

```{r load-lib-dir, eval=FALSE}
# load EHR package and dependencies
library(EHR)
library(pkdata)
library(lubridate)
```

# Quick Data Building with Processed Datasets

There are **four basic steps** to build a PK dataset quickly.

## (1) First define directories
* a directory for the raw data (`rawDataDir` in the example below)
* a directory for interactive checking output files (`checkDir` in the example below)

```{r define-directories}
# define directories
rawDataDir <- system.file("examples", "str_ex1", package="EHR")
td <- tempdir()
checkDir <- file.path(td, 'check1')
dir.create(checkDir)
```

## (2) Prepare cleaned and appropriately formatted data files and load the data files

Four types of files are used in the *Build-PK-IV* module:

* an IV dosing file
* a drug concentration file
* a demographic file
* a laboratory file (optional)

```{r simp-in}
# read in data
ivdose.data <- read.csv(file.path(rawDataDir,"IVDose_DATA_simple.csv"),stringsAsFactors = FALSE)
head(ivdose.data, 3)
conc.data <- read.csv(file.path(rawDataDir,"Concentration_DATA_simple.csv"),stringsAsFactors = FALSE)
head(conc.data, 3)
demo <- read.csv(file.path(rawDataDir,"Demographics_DATA_simple.csv"),stringsAsFactors = FALSE)
head(demo, 3)
creat.data <- read.csv(file.path(rawDataDir,"Creatinine_DATA_simple.csv"),stringsAsFactors = FALSE)
head(creat.data, 3)

```

All four of the above datasets have been cleaned and put in the appropriate data format. The `patient_id` variable is present in all four of the above datasets. This is a unique patient-level ID. The concentration and demographic files also contain a `patient_visit_id` variable, which is a unique visit-level ID. In order to run the *Build-PK-IV* module, these variables must be renamed, as we demonstrate in the next section.

## (3) Rename ID variables with standardized names
The `EHR` package modules use a standardized naming convention for patient identification (ID) variables. We rename the unique patient-level ID from `patient_id` to `mod_id` and the visit-level ID from `patient_visit_id` to `mod_id_visit`. If there is only a single visit/course per subject, the unique patient-level ID and visit-level ID can be the same, however both `mod_id` and `mod_id_visit` should be defined.

```{r simp-rename}
# rename ID variables
names(conc.data)[1:2] <- names(demo)[1:2] <- c("mod_id", "mod_id_visit")
names(creat.data)[1] <- names(ivdose.data)[1] <- "mod_id"

```


## (4) Build a final PK dataset with the function `run_Build_PK_IV()` using the prepared datasets above

The following arguments are used in the `run_Build_PK_IV` function:

* `conc`: concentration data
* `dose`: IV dose data
* `demo.list`: file name for demographic file
* `demo.vars`: vector of demographic variables to include in final output
* `demo.abbr`: vector of abbreviations for demographic variables in `demo.vars`
* `lab.dat`: list containing laboratory files
* `lab.vars`: vector containing names for laboratory files
* `pk.vars`: PK variables to include
* `drugname`: drug name stub
* `check.path`: file path where the generated files for data checking are stored, and the corresponding data files with fixed data exist

Below we show how to run `run_Build_PK_IV` using the example data from above.

```{r sim-build-pk-iv}
# running run_Build_PK_IV()
simple_pk_dat <- run_Build_PK_IV(
    conc=conc.data,
    dose=ivdose.data,
    demo.list = demo,
    demo.vars=c('weight', 'weight_demo', 'height', 'gender', 'ageatsurgery',
                'stat_sts', 'cpb_sts', 'length_of_icu_stay'),
    demo.abbr=c('wgt', 'wgt_demo', 'height', 'gender',
                'age', 'stat', 'cpb', 'loi'),
    lab.dat = list(creat.data),
    lab.vars = c('creat'),
    pk.vars=c('mod_id_visit', 'time', 'conc', 'dose', 'rate', 'event',
              'other', 'multiple.record', 'date', 'mod_id'),
    drugname='fent',
    check.path=checkDir)
```

Notice that the data building function generates an automatic message that tells some information about the data processing as well as the final dataset including the variables, the sample size, and missingness.

Below we show the final PK dataset.

```{r sim-build-pk-iv-out}
# the final PK dataset
head(simple_pk_dat,15)
```

This dataset includes the `mod_id_visit` variable and standard NONMEM formatted variables:

* time - time of dosing or concentration event
* conc - observed concentration (NA for dosing records)
* amt - dose amount administered (NA for concentration records)
* rate - rate of drug administration (e.g., rate=0 for bolus doses)
* mdv - missing dependent variable (dv) indicator (e.g., 0 = not missing dv, 1 = missing dv)
* evid - event ID (e.g., 0 = observation, 1 = dose event)

It also includes the demographic variables we specified in the `demo.vars` argument that have been renamed according to `demo.abbr`.

# References
1. Choi L, Beck C, McNeer E, Weeks HL, Williams ML, James NT, Niu X, Abou-Khalil BW, Birdwell KA, Roden DM, Stein CM. Development of a System for Post-marketing Population Pharmacokinetic and Pharmacodynamic Studies using Real-World Data from Electronic Health Records. Clinical Pharmacology & Therapeutics. 2020 Apr;107(4):934-43. doi: 10.1002/cpt.1787.
