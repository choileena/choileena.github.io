---
title: "Pro-Demographic"
description: |
  This tutorial describes how to process demographic data using *Pro-Demographic* module in the system.
author:
  - name: Michael L. Williams
output:
  distill::distill_article:
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(R.options = list(width = 120))
```

* See also "Pro-Demographic" in "[2. EHR Vignette for Structured Data](https://cran.r-project.org/web/packages/EHR/vignettes/ehr_vignette_02_str.html)" of `EHR` package.

# Introduction

This tutorial describes how to use the *Pro-Demographic* module to process demographic data (see Choi *et al.*$^{1}$ for details).

To begin we load the `EHR` package and create some directories to work from. 

```{r load-lib-dir, eval=TRUE}
# load EHR package
library(EHR)

td <- tempdir()
dir.create(file.path(td, 'checks'))
checkDir <- file.path(td, 'checks') # directory for interactive checking
dir.create(file.path(td, 'data'))
dataDir <- file.path(td, 'data') # directory for processed data\
rawDataDir <- system.file("examples", "str_ex2", package="EHR")
drugname <- 'fent'
LLOQ <- 0.05
```

# Demographic Data

We will use example demographic data to demonstrate the *Pro-Demographic* module. The raw data is shown below.

```{r}
demo.in <- demo.in <- readTransform(file.path(rawDataDir, "Demographics_DATA.csv"))
head(demo.in,10)
```

Each row in the data represents an individual surgical date.  In this case, each individual is assigned a unique ID and has a recorded gender, weight, and height for each surgery.  The goal of *Pro-Demographic* is to merge this information with medication data to make it suitable for population pharmacokinetic analysis. As such, it is recommended that users develop an understanding of *Pro-Med-NLP* and *Pro-Druglevel* as the *Pro-Demographic* module hfunctions in concert with those modules.

# Additional data

For our example we will merge the above demographic data with MAR data in the following form:

```{r mar-in}
mar.in0 <- read.csv(file.path(rawDataDir, "MAR_DATA.csv"), check.names = FALSE)
mar.in <- dataTransformation(mar.in0, rename = c('Uniq.Id' = 'subject_uid'))
head(mar.in)
```

Additionally, we will load in medication concentration data.  The two datasets together, dosing and concentration, form the basic data of population pharmacokinetic analysis

```{r}
# helper function used to make subject_id
sampId <- function(x) {
  # remove leading zeroes or trailing periods
  subid <- gsub('(^0*|\\.$)', '', x)
  # change _ to .
  gsub('_([0-9]+[_].*)$', '.\\1', subid)
}

# read SampleConcentration_DATA.csv
conc.in <- readTransform(file.path(rawDataDir, "SampleConcentration_DATA.csv"),
  modify = list(
    subid = expression(sampId(name)),
    subject_id = expression(as.numeric(sub('[_].*', '', subid))),
    samp = expression(sub('[^_]*[_]', '', subid)),
    name = NULL,
    data_file = NULL,
    subid = NULL
    )
  )
head(conc.in)
```


```{r}
# read SampleTimes_DATA.csv
samp.in <- readTransform(file.path(rawDataDir, "SampleTimes_DATA.csv"),
    rename = c('Study.ID' = 'subject_id'),
    modify = list(samp = expression(as.numeric(sub('Sample ', '', Event.Name)))))
head(samp.in)
```
# Establishing a unified ID system

We create a new ID system to aid de-identification of the dataset before further analysis.

```{r}
data <-  list(demo.in,
              mar.in,
              conc.in,
              samp.in)

# define list of vectors or character strings that identify the ID variables
idcols <-  list(c('subject_id','subject_uid'), # id vars in demo.in
                'subject_uid',
                'subject_id',
                'subject_id') # id var in mar.in) 

# merge all IDs from cleaned datasets and create new ID variables
id.xwalk <- idCrosswalk(data, idcols, visit.id="subject_id", uniq.id="subject_uid")
saveRDS(id.xwalk, file=file.path(dataDir,"module_id_xwalk.rds"))


demo.cln <- pullFakeId(demo.in, id.xwalk)
head(demo.cln)
saveRDS(demo.cln, file=file.path(dataDir,"demo.rds"))

mar.cln <- pullFakeId(mar.in, id.xwalk, firstCols = 'mod_id', uniq.id = 'subject_uid')
saveRDS(mar.cln, file=file.path(dataDir,"mar.rds"))

conc.cln <- pullFakeId(conc.in, id.xwalk,
    firstCols = c('record_id', 'mod_id', 'mod_visit', 'mod_id_visit', 'samp'),
    orderBy = 'record_id',
    uniq.id = 'subject_uid')
saveRDS(conc.cln, file=file.path(dataDir,"conc.rds"))

samp.cln <- pullFakeId(samp.in, id.xwalk,
    firstCols = c('mod_id', 'mod_visit', 'mod_id_visit', 'samp'), 
    orderBy = c('mod_id_visit','samp'),
    uniq.id = 'subject_uid')
saveRDS(samp.cln, file=file.path(dataDir,"samp_mod_id.rds"))
```

# Processing the Datasets

The three datasets are now ready for processing `run_Demo` will configure the demographic data.  Detailed descriptions for `run_MedStrI` and `run_DrugLevel` can be found in their respective modules, *Pro-Med-Str* and *Pro-DrugLevel*.

```{r}
demo.out <- run_Demo(demo.path = file.path(dataDir, "demo.rds"))
head(demo.out)
```

```{r}
ivdose.out <- run_MedStrI(mar.path=file.path(dataDir,"mar.rds"),
                          medchk.path=file.path(rawDataDir, "medChecked-fent.csv"),
                          check.path=checkDir,
                          drugname=drugname)
```



```{r}
conc.out <- run_DrugLevel(conc.path=file.path(dataDir,"conc.rds"),
    conc.select=c('mod_id','mod_id_visit','samp','fentanyl_calc_conc'),
    conc.rename=c(fentanyl_calc_conc = 'conc.level', samp= 'event'),
    conc.mod.list=list(mod_id_event = expression(paste(mod_id_visit, event, sep = '_'))),
    samp.path=file.path(dataDir,"samp_mod_id.rds"),
    samp.mod.list=list(mod_id_event = expression(paste(mod_id_visit, samp, sep = '_'))),
    check.path=checkDir,
    drugname=drugname,
    LLOQ=LLOQ,
    demo.list=demo.out)
```

# Building the final dataset

Pass the three processed datasets to `run_Build_PK_IV` now.  The three demographic characteristics of interest are gender, height and weight; this is specified as an argument of the function.

```{r}
pk_dat <- run_Build_PK_IV(
    conc=conc.out,
    dose=ivdose.out,
    demo.list=demo.out,
    demo.vars=c('gender', 'weight', 'height'),
    demo.abbr=c('gnd', 'wgt', 'hgt'),
    pk.vars=c('conc','mod_id_visit', 'time', 'dose', 'rate', 'event',
              'other', 'multiple.record', 'date', 'mod_id'),
    drugname=drugname,
    check.path=checkDir)

head(pk_dat)
```

This data is now of a form suitable for population pharmacokinetic analysis with demographic data appropriately incorporated.

# References
1. Choi L, Beck C, McNeer E, Weeks HL, Williams ML, James NT, Niu X, Abou-Khalil BW, Birdwell KA, Roden DM, Stein CM. Development of a System for Post-marketing Population Pharmacokinetic and Pharmacodynamic Studies using Real-World Data from Electronic Health Records. Clinical Pharmacology & Therapeutics. 2020 Apr;107(4):934-43. doi: 10.1002/cpt.1787.

