<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
  <meta name="generator" content="distill" />

  <style type="text/css">
  /* Hide doc at startup (prevent jankiness while JS renders/transforms) */
  body {
    visibility: hidden;
  }
  </style>

 <!--radix_placeholder_import_source-->
 <!--/radix_placeholder_import_source-->

  <!--radix_placeholder_meta_tags-->
  <title>Categorical Effects as Random</title>
  
  <meta property="description" itemprop="description" content="Exploring random slopes for categorical covariates and similar models"/>
  
  
  <!--  https://schema.org/Article -->
  <meta property="article:published" itemprop="datePublished" content="2020-03-01"/>
  <meta property="article:created" itemprop="dateCreated" content="2020-03-01"/>
  <meta name="article:author" content="Michael Clark"/>
  
  <!--  https://developers.facebook.com/docs/sharing/webmasters#markup -->
  <meta property="og:title" content="Categorical Effects as Random"/>
  <meta property="og:type" content="article"/>
  <meta property="og:description" content="Exploring random slopes for categorical covariates and similar models"/>
  <meta property="og:locale" content="en_US"/>
  
  <!--  https://dev.twitter.com/cards/types/summary -->
  <meta property="twitter:card" content="summary"/>
  <meta property="twitter:title" content="Categorical Effects as Random"/>
  <meta property="twitter:description" content="Exploring random slopes for categorical covariates and similar models"/>
  
  <!--/radix_placeholder_meta_tags-->
  <!--radix_placeholder_rmarkdown_metadata-->
  
  <script type="text/json" id="radix-rmarkdown-metadata">
  {"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["title","description","author","date","preview","output","draft","tags","categories"]}},"value":[{"type":"character","attributes":{},"value":["Categorical Effects as Random"]},{"type":"character","attributes":{},"value":["Exploring random slopes for categorical covariates and similar models\n"]},{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","url"]}},"value":[{"type":"character","attributes":{},"value":["Michael Clark"]},{"type":"character","attributes":{},"value":["https://m-clark.github.io"]}]}]},{"type":"character","attributes":{},"value":["2020-03-01"]},{"type":"character","attributes":{},"value":["../../img/cat_ran/machines.svg"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["distill::distill_article"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["self_contained","toc","css"]}},"value":[{"type":"logical","attributes":{},"value":[false]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["../../styles.css"]}]}]},{"type":"logical","attributes":{},"value":[false]},{"type":"character","attributes":{},"value":["mixed models","generalized linear mixed models","random effects","lme4","glmmTMB","lmer","glmer"]},{"type":"character","attributes":{},"value":["mixed models"]}]}
  </script>
  <!--/radix_placeholder_rmarkdown_metadata-->
  
  <script type="text/json" id="radix-resource-manifest">
  {"type":"character","attributes":{},"value":["random_categories_files/bowser-1.9.3/bowser.min.js","random_categories_files/distill-2.2.21/template.v2.js","random_categories_files/figure-html5/vis-data-1.svg","random_categories_files/jquery-1.11.3/jquery.min.js","random_categories_files/kePrint-0.0.1/kePrint.js","random_categories_files/webcomponents-2.0.0/webcomponents.js"]}
  </script>
  <!--radix_placeholder_navigation_in_header-->
  <!--/radix_placeholder_navigation_in_header-->
  <!--radix_placeholder_distill-->
  
  <style type="text/css">
  
  body {
    background-color: white;
  }
  
  .pandoc-table {
    width: 100%;
  }
  
  .pandoc-table>caption {
    margin-bottom: 10px;
  }
  
  .pandoc-table th:not([align]) {
    text-align: left;
  }
  
  .pagedtable-footer {
    font-size: 15px;
  }
  
  .html-widget {
    margin-bottom: 2.0em;
  }
  
  .l-screen-inset {
    padding-right: 16px;
  }
  
  .l-screen .caption {
    margin-left: 10px;
  }
  
  .shaded {
    background: rgb(247, 247, 247);
    padding-top: 20px;
    padding-bottom: 20px;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }
  
  .shaded .html-widget {
    margin-bottom: 0;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }
  
  .shaded .shaded-content {
    background: white;
  }
  
  .text-output {
    margin-top: 0;
    line-height: 1.5em;
  }
  
  .hidden {
    display: none !important;
  }
  
  d-article {
    padding-bottom: 30px;
  }
  
  d-appendix {
    padding-top: 30px;
  }
  
  d-article>p>img {
    width: 100%;
  }
  
  d-article iframe {
    border: 1px solid rgba(0, 0, 0, 0.1);
    margin-bottom: 2.0em;
    width: 100%;
  }
  
  figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }
  
  /* CSS for table of contents */
  
  .d-toc {
    color: rgba(0,0,0,0.8);
    font-size: 0.8em;
    line-height: 1em;
  }
  
  .d-toc-header {
    font-size: 0.6rem;
    font-weight: 400;
    color: rgba(0, 0, 0, 0.5);
    text-transform: uppercase;
    margin-top: 0;
    margin-bottom: 1.3em;
  }
  
  .d-toc a {
    border-bottom: none;
  }
  
  .d-toc ul {
    padding-left: 0;
  }
  
  .d-toc li>ul {
    padding-top: 0.8em;
    padding-left: 16px;
    margin-bottom: 0.6em;
  }
  
  .d-toc ul,
  .d-toc li {
    list-style-type: none;
  }
  
  .d-toc li {
    margin-bottom: 0.9em;
  }
  
  .d-toc-separator {
    margin-top: 20px;
    margin-bottom: 2em;
  }
  
  .d-article-with-toc {
    border-top: none;
    padding-top: 0;
  }
  
  
  
  /* Tweak code blocks (note that this CSS is repeated above in an injection
     into the d-code shadow dom) */
  
  d-code {
    overflow-x: auto !important;
  }
  
  pre.d-code code.d-code {
    padding-left: 10px;
    font-size: 12px;
    border-left: 2px solid rgba(0,0,0,0.1);
  }
  
  pre.text-output {
  
    font-size: 12px;
    color: black;
    background: none;
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;
  
    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;
  
    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }
  
  @media(min-width: 768px) {
  
  d-code {
    overflow-x: visible !important;
  }
  
  pre.d-code code.d-code  {
      padding-left: 18px;
      font-size: 14px;
  }
  pre.text-output {
    font-size: 14px;
  }
  }
  
  /* Figure */
  
  .figure {
    position: relative;
    margin-bottom: 2.5em;
    margin-top: 1.5em;
  }
  
  .figure img {
    width: 100%;
  }
  
  .figure .caption {
    color: rgba(0, 0, 0, 0.6);
    font-size: 12px;
    line-height: 1.5em;
  }
  
  .figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }
  
  .figure .caption a {
    color: rgba(0, 0, 0, 0.6);
  }
  
  .figure .caption b,
  .figure .caption strong, {
    font-weight: 600;
    color: rgba(0, 0, 0, 1.0);
  }
  
  
  
  /* Tweak 1000px media break to show more text */
  
  @media(min-width: 1000px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 80px [middle-start] 50px [text-start kicker-end] 65px 65px 65px 65px 65px 65px 65px 65px [text-end gutter-start] 65px [middle-end] 65px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 16px;
    }
  
    .grid {
      grid-column-gap: 16px;
    }
  
    d-article {
      font-size: 1.06rem;
      line-height: 1.7em;
    }
    figure .caption, .figure .caption, figure figcaption {
      font-size: 13px;
    }
  }
  
  @media(min-width: 1180px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 60px [middle-start] 60px [text-start kicker-end] 60px 60px 60px 60px 60px 60px 60px 60px [text-end gutter-start] 60px [middle-end] 60px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 32px;
    }
  
    .grid {
      grid-column-gap: 32px;
    }
  }
  
  
  /* Get the citation styles for the appendix (not auto-injected on render since
     we do our own rendering of the citation appendix) */
  
  d-appendix .citation-appendix,
  .d-appendix .citation-appendix {
    font-size: 11px;
    line-height: 15px;
    border-left: 1px solid rgba(0, 0, 0, 0.1);
    padding-left: 18px;
    border: 1px solid rgba(0,0,0,0.1);
    background: rgba(0, 0, 0, 0.02);
    padding: 10px 18px;
    border-radius: 3px;
    color: rgba(150, 150, 150, 1);
    overflow: hidden;
    margin-top: -12px;
    white-space: pre-wrap;
    word-wrap: break-word;
  }
  
  
  /* Social footer */
  
  .social_footer {
    margin-top: 30px;
    margin-bottom: 0;
    color: rgba(0,0,0,0.67);
  }
  
  .disqus-comments {
    margin-right: 30px;
  }
  
  .disqus-comment-count {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
    cursor: pointer;
  }
  
  #disqus_thread {
    margin-top: 30px;
  }
  
  .article-sharing a {
    border-bottom: none;
    margin-right: 8px;
  }
  
  .article-sharing a:hover {
    border-bottom: none;
  }
  
  .sidebar-section.subscribe {
    font-size: 12px;
    line-height: 1.6em;
  }
  
  .subscribe p {
    margin-bottom: 0.5em;
  }
  
  
  .article-footer .subscribe {
    font-size: 15px;
    margin-top: 45px;
  }
  
  
  /* Improve display for browsers without grid (IE/Edge <= 15) */
  
  .downlevel {
    line-height: 1.6em;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
    margin: 0;
  }
  
  .downlevel .d-title {
    padding-top: 6rem;
    padding-bottom: 1.5rem;
  }
  
  .downlevel .d-title h1 {
    font-size: 50px;
    font-weight: 700;
    line-height: 1.1em;
    margin: 0 0 0.5rem;
  }
  
  .downlevel .d-title p {
    font-weight: 300;
    font-size: 1.2rem;
    line-height: 1.55em;
    margin-top: 0;
  }
  
  .downlevel .d-byline {
    padding-top: 0.8em;
    padding-bottom: 0.8em;
    font-size: 0.8rem;
    line-height: 1.8em;
  }
  
  .downlevel .section-separator {
    border: none;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
  }
  
  .downlevel .d-article {
    font-size: 1.06rem;
    line-height: 1.7em;
    padding-top: 1rem;
    padding-bottom: 2rem;
  }
  
  
  .downlevel .d-appendix {
    padding-left: 0;
    padding-right: 0;
    max-width: none;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.5);
    padding-top: 40px;
    padding-bottom: 48px;
  }
  
  .downlevel .footnotes ol {
    padding-left: 13px;
  }
  
  .downlevel .base-grid,
  .downlevel .distill-header,
  .downlevel .d-title,
  .downlevel .d-abstract,
  .downlevel .d-article,
  .downlevel .d-appendix,
  .downlevel .distill-appendix,
  .downlevel .d-byline,
  .downlevel .d-footnote-list,
  .downlevel .d-citation-list,
  .downlevel .distill-footer,
  .downlevel .appendix-bottom,
  .downlevel .posts-container {
    padding-left: 40px;
    padding-right: 40px;
  }
  
  @media(min-width: 768px) {
    .downlevel .base-grid,
    .downlevel .distill-header,
    .downlevel .d-title,
    .downlevel .d-abstract,
    .downlevel .d-article,
    .downlevel .d-appendix,
    .downlevel .distill-appendix,
    .downlevel .d-byline,
    .downlevel .d-footnote-list,
    .downlevel .d-citation-list,
    .downlevel .distill-footer,
    .downlevel .appendix-bottom,
    .downlevel .posts-container {
    padding-left: 150px;
    padding-right: 150px;
    max-width: 900px;
  }
  }
  
  .downlevel pre code {
    display: block;
    border-left: 2px solid rgba(0, 0, 0, .1);
    padding: 0 0 0 20px;
    font-size: 14px;
  }
  
  .downlevel code, .downlevel pre {
    color: black;
    background: none;
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;
  
    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;
  
    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }
  
  </style>
  
  <script type="application/javascript">
  
  function is_downlevel_browser() {
    if (bowser.isUnsupportedBrowser({ msie: "12", msedge: "16"},
                                   window.navigator.userAgent)) {
      return true;
    } else {
      return window.load_distill_framework === undefined;
    }
  }
  
  // show body when load is complete
  function on_load_complete() {
  
    // set body to visible
    document.body.style.visibility = 'visible';
  
    // force redraw for leaflet widgets
    if (window.HTMLWidgets) {
      var maps = window.HTMLWidgets.findAll(".leaflet");
      $.each(maps, function(i, el) {
        var map = this.getMap();
        map.invalidateSize();
        map.eachLayer(function(layer) {
          if (layer instanceof L.TileLayer)
            layer.redraw();
        });
      });
    }
  
    // trigger 'shown' so htmlwidgets resize
    $('d-article').trigger('shown');
  }
  
  function init_distill() {
  
    init_common();
  
    // create front matter
    var front_matter = $('<d-front-matter></d-front-matter>');
    $('#distill-front-matter').wrap(front_matter);
  
    // create d-title
    $('.d-title').changeElementType('d-title');
  
    // create d-byline
    var byline = $('<d-byline></d-byline>');
    $('.d-byline').replaceWith(byline);
  
    // create d-article
    var article = $('<d-article></d-article>');
    $('.d-article').wrap(article).children().unwrap();
  
    // move posts container into article
    $('.posts-container').appendTo($('d-article'));
  
    // create d-appendix
    $('.d-appendix').changeElementType('d-appendix');
  
    // create d-bibliography
    var bibliography = $('<d-bibliography></d-bibliography>');
    $('#distill-bibliography').wrap(bibliography);
  
    // flag indicating that we have appendix items
    var appendix = $('.appendix-bottom').children('h3').length > 0;
  
    // replace citations with <d-cite>
    $('.citation').each(function(i, val) {
      appendix = true;
      var cites = $(this).attr('data-cites').split(" ");
      var dt_cite = $('<d-cite></d-cite>');
      dt_cite.attr('key', cites.join());
      $(this).replaceWith(dt_cite);
    });
    // remove refs
    $('#refs').remove();
  
    // replace footnotes with <d-footnote>
    $('.footnote-ref').each(function(i, val) {
      appendix = true;
      var href = $(this).attr('href');
      var id = href.replace('#', '');
      var fn = $('#' + id);
      var fn_p = $('#' + id + '>p');
      fn_p.find('.footnote-back').remove();
      var text = fn_p.html();
      var dtfn = $('<d-footnote></d-footnote>');
      dtfn.html(text);
      $(this).replaceWith(dtfn);
    });
    // remove footnotes
    $('.footnotes').remove();
  
    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      var id = $(this).attr('id');
      $('.d-toc a[href="#' + id + '"]').parent().remove();
      appendix = true;
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('d-appendix'));
    });
  
    // show d-appendix if we have appendix content
    $("d-appendix").css('display', appendix ? 'grid' : 'none');
  
    // replace code blocks with d-code
    $('pre>code').each(function(i, val) {
      var code = $(this);
      var pre = code.parent();
      var clz = "";
      var language = pre.attr('class');
      if (language) {
        // map unknown languages to "clike" (without this they just dissapear)
        if ($.inArray(language, ["bash", "clike", "css", "go", "html",
                                 "javascript", "js", "julia", "lua", "markdown",
                                 "markup", "mathml", "python", "svg", "xml"]) == -1)
          language = "clike";
        language = ' language="' + language + '"';
        var dt_code = $('<d-code block' + language + clz + '></d-code>');
        dt_code.text(code.text());
        pre.replaceWith(dt_code);
      } else {
        code.addClass('text-output').unwrap().changeElementType('pre');
      }
    });
  
    // localize layout chunks to just output
    $('.layout-chunk').each(function(i, val) {
  
      // capture layout
      var layout = $(this).attr('data-layout');
  
      // apply layout to markdown level block elements
      var elements = $(this).children().not('d-code, pre.text-output, script');
      elements.each(function(i, el) {
        var layout_div = $('<div class="' + layout + '"></div>');
        if (layout_div.hasClass('shaded')) {
          var shaded_content = $('<div class="shaded-content"></div>');
          $(this).wrap(shaded_content);
          $(this).parent().wrap(layout_div);
        } else {
          $(this).wrap(layout_div);
        }
      });
  
  
      // unwrap the layout-chunk div
      $(this).children().unwrap();
    });
  
    // load distill framework
    load_distill_framework();
  
    // wait for window.distillRunlevel == 4 to do post processing
    function distill_post_process() {
  
      if (!window.distillRunlevel || window.distillRunlevel < 4)
        return;
  
      // hide author/affiliations entirely if we have no authors
      var front_matter = JSON.parse($("#distill-front-matter").html());
      var have_authors = front_matter.authors && front_matter.authors.length > 0;
      if (!have_authors)
        $('d-byline').addClass('hidden');
  
      // table of contents
      if (have_authors) // adjust border if we are in authors
        $('.d-toc').parent().addClass('d-article-with-toc');
  
      // strip links that point to #
      $('.authors-affiliations').find('a[href="#"]').removeAttr('href');
  
      // hide elements of author/affiliations grid that have no value
      function hide_byline_column(caption) {
        $('d-byline').find('h3:contains("' + caption + '")').parent().css('visibility', 'hidden');
      }
  
      // affiliations
      var have_affiliations = false;
      for (var i = 0; i<front_matter.authors.length; ++i) {
        var author = front_matter.authors[i];
        if (author.affiliation !== "&nbsp;") {
          have_affiliations = true;
          break;
        }
      }
      if (!have_affiliations)
        $('d-byline').find('h3:contains("Affiliations")').css('visibility', 'hidden');
  
      // published date
      if (!front_matter.publishedDate)
        hide_byline_column("Published");
  
      // document object identifier
      var doi = $('d-byline').find('h3:contains("DOI")');
      var doi_p = doi.next().empty();
      if (!front_matter.doi) {
        // if we have a citation and valid citationText then link to that
        if ($('#citation').length > 0 && front_matter.citationText) {
          doi.html('Citation');
          $('<a href="#citation"></a>')
            .text(front_matter.citationText)
            .appendTo(doi_p);
        } else {
          hide_byline_column("DOI");
        }
      } else {
        $('<a></a>')
           .attr('href', "https://doi.org/" + front_matter.doi)
           .html(front_matter.doi)
           .appendTo(doi_p);
      }
  
       // change plural form of authors/affiliations
      if (front_matter.authors.length === 1) {
        var grid = $('.authors-affiliations');
        grid.children('h3:contains("Authors")').text('Author');
        grid.children('h3:contains("Affiliations")').text('Affiliation');
      }
  
      // inject pre code styles (can't do this with a global stylesheet b/c a shadow root is used)
      $('d-code').each(function(i, val) {
        var style = document.createElement('style');
        style.innerHTML = 'pre code { padding-left: 10px; font-size: 12px; border-left: 2px solid rgba(0,0,0,0.1); } ' +
                          '@media(min-width: 768px) { pre code { padding-left: 18px; font-size: 14px; } }';
        if (this.shadowRoot)
          this.shadowRoot.appendChild(style);
      });
  
      // move appendix-bottom entries to the bottom
      $('.appendix-bottom').appendTo('d-appendix').children().unwrap();
      $('.appendix-bottom').remove();
  
      // clear polling timer
      clearInterval(tid);
  
      // show body now that everything is ready
      on_load_complete();
    }
  
    var tid = setInterval(distill_post_process, 50);
    distill_post_process();
  
  }
  
  function init_downlevel() {
  
    init_common();
  
     // insert hr after d-title
    $('.d-title').after($('<hr class="section-separator"/>'));
  
    // check if we have authors
    var front_matter = JSON.parse($("#distill-front-matter").html());
    var have_authors = front_matter.authors && front_matter.authors.length > 0;
  
    // manage byline/border
    if (!have_authors)
      $('.d-byline').remove();
    $('.d-byline').after($('<hr class="section-separator"/>'));
    $('.d-byline a').remove();
  
    // remove toc
    $('.d-toc-header').remove();
    $('.d-toc').remove();
    $('.d-toc-separator').remove();
  
    // move appendix elements
    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('.d-appendix'));
    });
  
  
    // inject headers into references and footnotes
    var refs_header = $('<h3></h3>');
    refs_header.text('References');
    $('#refs').prepend(refs_header);
  
    var footnotes_header = $('<h3></h3');
    footnotes_header.text('Footnotes');
    $('.footnotes').children('hr').first().replaceWith(footnotes_header);
  
    // move appendix-bottom entries to the bottom
    $('.appendix-bottom').appendTo('.d-appendix').children().unwrap();
    $('.appendix-bottom').remove();
  
    // remove appendix if it's empty
    if ($('.d-appendix').children().length === 0)
      $('.d-appendix').remove();
  
    // prepend separator above appendix
    $('.d-appendix').before($('<hr class="section-separator" style="clear: both"/>'));
  
    // trim code
    $('pre>code').each(function(i, val) {
      $(this).html($.trim($(this).html()));
    });
  
    // move posts-container right before article
    $('.posts-container').insertBefore($('.d-article'));
  
    $('body').addClass('downlevel');
  
    on_load_complete();
  }
  
  
  function init_common() {
  
    // jquery plugin to change element types
    (function($) {
      $.fn.changeElementType = function(newType) {
        var attrs = {};
  
        $.each(this[0].attributes, function(idx, attr) {
          attrs[attr.nodeName] = attr.nodeValue;
        });
  
        this.replaceWith(function() {
          return $("<" + newType + "/>", attrs).append($(this).contents());
        });
      };
    })(jQuery);
  
    // prevent underline for linked images
    $('a > img').parent().css({'border-bottom' : 'none'});
  
    // mark non-body figures created by knitr chunks as 100% width
    $('.layout-chunk').each(function(i, val) {
      var figures = $(this).find('img, .html-widget');
      if ($(this).attr('data-layout') !== "l-body") {
        figures.css('width', '100%');
      } else {
        figures.css('max-width', '100%');
        figures.filter("[width]").each(function(i, val) {
          var fig = $(this);
          fig.css('width', fig.attr('width') + 'px');
        });
  
      }
    });
  
    // auto-append index.html to post-preview links in file: protocol
    // and in rstudio ide preview
    $('.post-preview').each(function(i, val) {
      if (window.location.protocol === "file:")
        $(this).attr('href', $(this).attr('href') + "index.html");
    });
  
    // get rid of index.html references in header
    if (window.location.protocol !== "file:") {
      $('.distill-site-header a[href]').each(function(i,val) {
        $(this).attr('href', $(this).attr('href').replace("index.html", "./"));
      });
    }
  
    // add class to pandoc style tables
    $('tr.header').parent('thead').parent('table').addClass('pandoc-table');
    $('.kable-table').children('table').addClass('pandoc-table');
  
    // add figcaption style to table captions
    $('caption').parent('table').addClass("figcaption");
  
    // initialize posts list
    if (window.init_posts_list)
      window.init_posts_list();
  
    // implmement disqus comment link
    $('.disqus-comment-count').click(function() {
      window.headroom_prevent_pin = true;
      $('#disqus_thread').toggleClass('hidden');
      if (!$('#disqus_thread').hasClass('hidden')) {
        var offset = $(this).offset();
        $(window).resize();
        $('html, body').animate({
          scrollTop: offset.top - 35
        });
      }
    });
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    if (is_downlevel_browser())
      init_downlevel();
    else
      window.addEventListener('WebComponentsReady', init_distill);
  });
  
  </script>
  
  <!--/radix_placeholder_distill-->
  <script src="random_categories_files/kePrint-0.0.1/kePrint.js"></script>
  <script src="random_categories_files/jquery-1.11.3/jquery.min.js"></script>
  <script src="random_categories_files/bowser-1.9.3/bowser.min.js"></script>
  <script src="random_categories_files/webcomponents-2.0.0/webcomponents.js"></script>
  <script src="random_categories_files/distill-2.2.21/template.v2.js"></script>
  <!--radix_placeholder_site_in_header-->
  <!--/radix_placeholder_site_in_header-->

  <link rel="stylesheet" href="../../styles.css" type="text/css"/>

</head>

<body>

<!--radix_placeholder_front_matter-->

<script id="distill-front-matter" type="text/json">
{"title":"Categorical Effects as Random","description":"Exploring random slopes for categorical covariates and similar models","authors":[{"author":"Michael Clark","authorURL":"https://m-clark.github.io","affiliation":"&nbsp;","affiliationURL":"#"}],"publishedDate":"2020-03-01T00:00:00.000-05:00","citationText":"Clark, 2020"}
</script>

<!--/radix_placeholder_front_matter-->
<!--radix_placeholder_navigation_before_body-->
<!--/radix_placeholder_navigation_before_body-->
<!--radix_placeholder_site_before_body-->
<!--/radix_placeholder_site_before_body-->

<div class="d-title">
<h1>Categorical Effects as Random</h1>
<p><p>Exploring random slopes for categorical covariates and similar models</p></p>
</div>

<div class="d-byline">
  Michael Clark <a href="https://m-clark.github.io" class="uri">https://m-clark.github.io</a> 
  
<br/>2020-03-01
</div>

<div class="d-article">
<h3 class="d-toc-header">Table of Contents</h3>
<nav class="d-toc" id="TOC">
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#machines">Machines</a><ul>
<li><a href="#the-data">The Data</a></li>
<li><a href="#random-effects-models">Random Effects Models</a></li>
<li><a href="#summarize-all-the-models">Summarize All the Models</a></li>
</ul></li>
<li><a href="#simulation">Simulation</a><ul>
<li><a href="#data-creation">Data Creation</a></li>
<li><a href="#run-the-models-summarize">Run the Models &amp; Summarize</a></li>
<li><a href="#change-the-model-orientation">Change the model orientation</a></li>
</ul></li>
<li><a href="#summary">Summary</a></li>
</ul>
</nav>
<hr class="d-toc-separator"/>
<aside>
Last updated March 09, 2020.
</aside>
<p>Prerequisites: familiarity with <a href="https://m-clark.github.io/mixed-models-with-R/">mixed models</a></p>
<h2 id="introduction">Introduction</h2>
<p>It’s often the case where, for mixed models, we want to look at random ‘slopes’ as well as random intercepts, such that coefficients for the fixed effects are expected to vary by group. This is very common in longitudinal settings, were we want to examine an overall trend, but allow the trend to vary by individual.</p>
<p>In such settings, when time is numeric, things are straightforward. The variance components are decomposed into parts for the intercept, the coefficient for the time indicator, and the residual variance (for linear mixed models). But what happens if we have only three time points? Does it make sense to treat it as numeric and hope for the best?</p>
<p>This came up in consulting because someone had a similar issue, and tried to keep the format for random slopes while treating the time indicator as categorical. This led to convergence issues, so we thought about what models might be possible. This post explores that scenario.</p>
<p>Packages used:</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
library(tidyverse)
library(lme4)
library(mixedup)  # http://m-clark.github.io/mixedup</code></pre>
</div>
<h2 id="machines">Machines</h2>
<h3 id="the-data">The Data</h3>
<p>Let’s start with a very simple data set from the <span class="pack" style="">nlme</span> package, which comes with the standard R installation. The reason I chose this is because <a href="http://pages.stat.wisc.edu/~bates/UseR2008/WorkshopD.pdf">Doug Bates has a good treatment on this topic</a> using that example (starting at slide 85), which I just extend a bit.</p>
<p>Here is the data description from the help file.</p>
<blockquote>
<p>Data on an experiment to compare three brands of machines used in an industrial process are presented in Milliken and Johnson (p. 285, 1992). Six workers were chosen randomly among the employees of a factory to operate each machine three times. The response is an overall productivity score taking into account the number and quality of components produced.</p>
</blockquote>
<p>So for each worker and each machine, we’ll have three scores. Let’s look.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
machines = nlme::Machines

# for some reason worker is an ordered factor.
machines = machines %&gt;% 
  mutate(Worker = factor(Worker, levels = 1:6, ordered = FALSE))</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
Worker
</th>
<th style="text-align:left;">
Machine
</th>
<th style="text-align:right;">
score
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
1
</td>
<td style="text-align:left;">
A
</td>
<td style="text-align:right;">
52.0
</td>
</tr>
<tr>
<td style="text-align:left;">
1
</td>
<td style="text-align:left;">
A
</td>
<td style="text-align:right;">
52.8
</td>
</tr>
<tr>
<td style="text-align:left;">
1
</td>
<td style="text-align:left;">
A
</td>
<td style="text-align:right;">
53.1
</td>
</tr>
<tr>
<td style="text-align:left;">
1
</td>
<td style="text-align:left;">
B
</td>
<td style="text-align:right;">
62.1
</td>
</tr>
<tr>
<td style="text-align:left;">
1
</td>
<td style="text-align:left;">
B
</td>
<td style="text-align:right;">
62.6
</td>
</tr>
<tr>
<td style="text-align:left;">
1
</td>
<td style="text-align:left;">
B
</td>
<td style="text-align:right;">
64.0
</td>
</tr>
</tbody>
</table>
</div>
<p>This duplicates the plot in Bates’ notes and visually describes the entire data set. There likely is variability due to both workers and machines.</p>
<div class="layout-chunk" data-layout="l-body">
<p><img src="random_categories_files/figure-html5/vis-data-1.svg" width="624" style="display: block; margin: auto;" /></p>
</div>
<h3 id="random-effects-models">Random Effects Models</h3>
<p>The random effects of potential interest are for worker and machine, so how do we specify this? Let’s try a standard approach. The following is the type of model tried by our client.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
model_m_slope = lmer(score ~ Machine + (1 + Machine | Worker), machines)</code></pre>
<pre><code>
Warning in checkConv(attr(opt, &quot;derivs&quot;), opt$par, ctrl = control$checkConv, : Model failed to converge with max|grad| =
0.00805193 (tol = 0.002, component 1)</code></pre>
</div>
<p>This was exactly the same issue our client had- problematic convergence. This could be more of an issue with <span class="pack" style="">lme4</span>, and we could certainly explore tweaks to make the problem go away (or use a different package like <span class="pack" style="">glmmTMB</span>), but let’s go ahead and keep it.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
summarize_model(model_m_slope, ci = FALSE, cor_re = TRUE)</code></pre>
<pre><code>
Variance Components:</code></pre>
<pre><code>
    Group    Effect Variance   SD Var_prop
   Worker Intercept    16.68 4.08     0.25
   Worker  MachineB    34.72 5.89     0.53
   Worker  MachineC    13.62 3.69     0.21
 Residual               0.92 0.96     0.01</code></pre>
<pre><code>
Correlation of Random Effects:</code></pre>
<pre><code>
          Intercept MachineB MachineC
Intercept      1.00     0.49    -0.36
MachineB       0.49     1.00     0.30
MachineC      -0.36     0.30     1.00</code></pre>
<pre><code>

Fixed Effects:</code></pre>
<pre><code>
      Term Value   SE     t P_value Lower_2.5 Upper_97.5
 Intercept 52.36 1.68 31.12    0.00     49.06      55.65
  MachineB  7.97 2.43  3.28    0.00      3.21      12.72
  MachineC 13.92 1.54  9.03    0.00     10.90      16.94</code></pre>
</div>
<p>We get the variance components we expect, i.e. the variance attributable to the intercept (i.e. Machine A), as well as for the slopes for the difference in machine B vs. A, and C vs. A. We also see the correlations among the random effects. It’s this part that Bates acknowledges is hard to estimate, and incurs estimating potentially notably more parameters than typical random effects models. We have different options that will be available to us though, so let’s try some.</p>
<p>Let’s start with the simplest, most plausible models. The first would be to have at least a worker effect. The next baseline model could be if we only had a machine by worker effect, i.e. a separate effect of each machine for each worker, essentially treating the interaction term as the sole clustering unit.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
model_base_w  = lmer(score ~ Machine + (1 | Worker), machines)
model_base_wm = lmer(score ~ Machine + (1 | Worker:Machine), machines)</code></pre>
</div>
<p>Examining the random effects makes clear the difference between the two models. For our first baseline model, we only have 6 effects, one for each worker. For the second we have an effect of each machine for each worker.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
extract_random_effects(model_base_w)  # only 6 effects
extract_random_effects(model_base_wm) # 6 workers by 3 machines = 18 effects</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
group_var
</th>
<th style="text-align:left;">
effect
</th>
<th style="text-align:left;">
group
</th>
<th style="text-align:right;">
value
</th>
<th style="text-align:right;">
se
</th>
<th style="text-align:right;">
lower_2.5
</th>
<th style="text-align:right;">
upper_97.5
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Worker
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
1
</td>
<td style="text-align:right;">
1.210
</td>
<td style="text-align:right;">
1.032
</td>
<td style="text-align:right;">
-0.813
</td>
<td style="text-align:right;">
3.234
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
2
</td>
<td style="text-align:right;">
-1.594
</td>
<td style="text-align:right;">
1.032
</td>
<td style="text-align:right;">
-3.618
</td>
<td style="text-align:right;">
0.429
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
3
</td>
<td style="text-align:right;">
6.212
</td>
<td style="text-align:right;">
1.032
</td>
<td style="text-align:right;">
4.188
</td>
<td style="text-align:right;">
8.235
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
4
</td>
<td style="text-align:right;">
-0.069
</td>
<td style="text-align:right;">
1.032
</td>
<td style="text-align:right;">
-2.093
</td>
<td style="text-align:right;">
1.954
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
5
</td>
<td style="text-align:right;">
2.949
</td>
<td style="text-align:right;">
1.032
</td>
<td style="text-align:right;">
0.925
</td>
<td style="text-align:right;">
4.972
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
6
</td>
<td style="text-align:right;">
-8.707
</td>
<td style="text-align:right;">
1.032
</td>
<td style="text-align:right;">
-10.731
</td>
<td style="text-align:right;">
-6.684
</td>
</tr>
</tbody>
</table>
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
group_var
</th>
<th style="text-align:left;">
effect
</th>
<th style="text-align:left;">
group
</th>
<th style="text-align:right;">
value
</th>
<th style="text-align:right;">
se
</th>
<th style="text-align:right;">
lower_2.5
</th>
<th style="text-align:right;">
upper_97.5
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
1:A
</td>
<td style="text-align:right;">
0.275
</td>
<td style="text-align:right;">
0.553
</td>
<td style="text-align:right;">
-0.808
</td>
<td style="text-align:right;">
1.359
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
1:B
</td>
<td style="text-align:right;">
2.556
</td>
<td style="text-align:right;">
0.553
</td>
<td style="text-align:right;">
1.473
</td>
<td style="text-align:right;">
3.640
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
1:C
</td>
<td style="text-align:right;">
0.920
</td>
<td style="text-align:right;">
0.553
</td>
<td style="text-align:right;">
-0.164
</td>
<td style="text-align:right;">
2.004
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
2:A
</td>
<td style="text-align:right;">
0.209
</td>
<td style="text-align:right;">
0.553
</td>
<td style="text-align:right;">
-0.874
</td>
<td style="text-align:right;">
1.293
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
2:B
</td>
<td style="text-align:right;">
-0.749
</td>
<td style="text-align:right;">
0.553
</td>
<td style="text-align:right;">
-1.833
</td>
<td style="text-align:right;">
0.334
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
2:C
</td>
<td style="text-align:right;">
-4.402
</td>
<td style="text-align:right;">
0.553
</td>
<td style="text-align:right;">
-5.486
</td>
<td style="text-align:right;">
-3.318
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
3:A
</td>
<td style="text-align:right;">
7.118
</td>
<td style="text-align:right;">
0.553
</td>
<td style="text-align:right;">
6.035
</td>
<td style="text-align:right;">
8.202
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
3:B
</td>
<td style="text-align:right;">
7.647
</td>
<td style="text-align:right;">
0.553
</td>
<td style="text-align:right;">
6.563
</td>
<td style="text-align:right;">
8.731
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
3:C
</td>
<td style="text-align:right;">
4.490
</td>
<td style="text-align:right;">
0.553
</td>
<td style="text-align:right;">
3.407
</td>
<td style="text-align:right;">
5.574
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
4:A
</td>
<td style="text-align:right;">
-1.113
</td>
<td style="text-align:right;">
0.553
</td>
<td style="text-align:right;">
-2.196
</td>
<td style="text-align:right;">
-0.029
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
4:B
</td>
<td style="text-align:right;">
2.391
</td>
<td style="text-align:right;">
0.553
</td>
<td style="text-align:right;">
1.307
</td>
<td style="text-align:right;">
3.475
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
4:C
</td>
<td style="text-align:right;">
-1.493
</td>
<td style="text-align:right;">
0.553
</td>
<td style="text-align:right;">
-2.577
</td>
<td style="text-align:right;">
-0.409
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
5:A
</td>
<td style="text-align:right;">
-0.981
</td>
<td style="text-align:right;">
0.553
</td>
<td style="text-align:right;">
-2.064
</td>
<td style="text-align:right;">
0.103
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
5:B
</td>
<td style="text-align:right;">
4.705
</td>
<td style="text-align:right;">
0.553
</td>
<td style="text-align:right;">
3.621
</td>
<td style="text-align:right;">
5.789
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
5:C
</td>
<td style="text-align:right;">
5.416
</td>
<td style="text-align:right;">
0.553
</td>
<td style="text-align:right;">
4.332
</td>
<td style="text-align:right;">
6.499
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
6:A
</td>
<td style="text-align:right;">
-5.509
</td>
<td style="text-align:right;">
0.553
</td>
<td style="text-align:right;">
-6.593
</td>
<td style="text-align:right;">
-4.426
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
6:B
</td>
<td style="text-align:right;">
-16.550
</td>
<td style="text-align:right;">
0.553
</td>
<td style="text-align:right;">
-17.634
</td>
<td style="text-align:right;">
-15.467
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
6:C
</td>
<td style="text-align:right;">
-4.931
</td>
<td style="text-align:right;">
0.553
</td>
<td style="text-align:right;">
-6.014
</td>
<td style="text-align:right;">
-3.847
</td>
</tr>
</tbody>
</table>
</div>
<p>As a next step, we’ll essentially combine our two baseline models.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
model_w_wm = lmer(score ~ Machine + (1 | Worker) + (1 | Worker:Machine), machines)</code></pre>
</div>
<p>Now we have 6 worker effects plus 18 machine within worker effects<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
extract_random_effects(model_w_wm)</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
group_var
</th>
<th style="text-align:left;">
effect
</th>
<th style="text-align:left;">
group
</th>
<th style="text-align:right;">
value
</th>
<th style="text-align:right;">
se
</th>
<th style="text-align:right;">
lower_2.5
</th>
<th style="text-align:right;">
upper_97.5
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
1:A
</td>
<td style="text-align:right;">
-0.750
</td>
<td style="text-align:right;">
2.015
</td>
<td style="text-align:right;">
-4.699
</td>
<td style="text-align:right;">
3.198
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
1:B
</td>
<td style="text-align:right;">
1.500
</td>
<td style="text-align:right;">
2.015
</td>
<td style="text-align:right;">
-2.449
</td>
<td style="text-align:right;">
5.449
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
1:C
</td>
<td style="text-align:right;">
-0.114
</td>
<td style="text-align:right;">
2.015
</td>
<td style="text-align:right;">
-4.063
</td>
<td style="text-align:right;">
3.834
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
2:A
</td>
<td style="text-align:right;">
1.553
</td>
<td style="text-align:right;">
2.015
</td>
<td style="text-align:right;">
-2.396
</td>
<td style="text-align:right;">
5.501
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
2:B
</td>
<td style="text-align:right;">
0.607
</td>
<td style="text-align:right;">
2.015
</td>
<td style="text-align:right;">
-3.342
</td>
<td style="text-align:right;">
4.555
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
2:C
</td>
<td style="text-align:right;">
-2.997
</td>
<td style="text-align:right;">
2.015
</td>
<td style="text-align:right;">
-6.945
</td>
<td style="text-align:right;">
0.952
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
3:A
</td>
<td style="text-align:right;">
1.778
</td>
<td style="text-align:right;">
2.015
</td>
<td style="text-align:right;">
-2.171
</td>
<td style="text-align:right;">
5.726
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
3:B
</td>
<td style="text-align:right;">
2.299
</td>
<td style="text-align:right;">
2.015
</td>
<td style="text-align:right;">
-1.649
</td>
<td style="text-align:right;">
6.248
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
3:C
</td>
<td style="text-align:right;">
-0.815
</td>
<td style="text-align:right;">
2.015
</td>
<td style="text-align:right;">
-4.763
</td>
<td style="text-align:right;">
3.134
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
4:A
</td>
<td style="text-align:right;">
-1.039
</td>
<td style="text-align:right;">
2.015
</td>
<td style="text-align:right;">
-4.988
</td>
<td style="text-align:right;">
2.909
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
4:B
</td>
<td style="text-align:right;">
2.417
</td>
<td style="text-align:right;">
2.015
</td>
<td style="text-align:right;">
-1.531
</td>
<td style="text-align:right;">
6.366
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
4:C
</td>
<td style="text-align:right;">
-1.414
</td>
<td style="text-align:right;">
2.015
</td>
<td style="text-align:right;">
-5.363
</td>
<td style="text-align:right;">
2.534
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
5:A
</td>
<td style="text-align:right;">
-3.457
</td>
<td style="text-align:right;">
2.015
</td>
<td style="text-align:right;">
-7.405
</td>
<td style="text-align:right;">
0.492
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
5:B
</td>
<td style="text-align:right;">
2.152
</td>
<td style="text-align:right;">
2.015
</td>
<td style="text-align:right;">
-1.796
</td>
<td style="text-align:right;">
6.101
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
5:C
</td>
<td style="text-align:right;">
2.853
</td>
<td style="text-align:right;">
2.015
</td>
<td style="text-align:right;">
-1.095
</td>
<td style="text-align:right;">
6.802
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
6:A
</td>
<td style="text-align:right;">
1.916
</td>
<td style="text-align:right;">
2.015
</td>
<td style="text-align:right;">
-2.032
</td>
<td style="text-align:right;">
5.865
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
6:B
</td>
<td style="text-align:right;">
-8.976
</td>
<td style="text-align:right;">
2.015
</td>
<td style="text-align:right;">
-12.924
</td>
<td style="text-align:right;">
-5.027
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
6:C
</td>
<td style="text-align:right;">
2.487
</td>
<td style="text-align:right;">
2.015
</td>
<td style="text-align:right;">
-1.462
</td>
<td style="text-align:right;">
6.435
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
1
</td>
<td style="text-align:right;">
1.045
</td>
<td style="text-align:right;">
1.981
</td>
<td style="text-align:right;">
-2.839
</td>
<td style="text-align:right;">
4.928
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
2
</td>
<td style="text-align:right;">
-1.376
</td>
<td style="text-align:right;">
1.981
</td>
<td style="text-align:right;">
-5.259
</td>
<td style="text-align:right;">
2.507
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
3
</td>
<td style="text-align:right;">
5.361
</td>
<td style="text-align:right;">
1.981
</td>
<td style="text-align:right;">
1.478
</td>
<td style="text-align:right;">
9.244
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
4
</td>
<td style="text-align:right;">
-0.060
</td>
<td style="text-align:right;">
1.981
</td>
<td style="text-align:right;">
-3.943
</td>
<td style="text-align:right;">
3.823
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
5
</td>
<td style="text-align:right;">
2.545
</td>
<td style="text-align:right;">
1.981
</td>
<td style="text-align:right;">
-1.339
</td>
<td style="text-align:right;">
6.428
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
6
</td>
<td style="text-align:right;">
-7.514
</td>
<td style="text-align:right;">
1.981
</td>
<td style="text-align:right;">
-11.397
</td>
<td style="text-align:right;">
-3.631
</td>
</tr>
</tbody>
</table>
</div>
<p>If you look closely at these effects, and add them together, you will get a value similar to our second baseline model, which is probably not too surprising. For example in the above model <code>1:B + 1</code> = 1.5 <code>+</code> 1.045. Looking at the initial model, the estimated random effect for <code>1:B</code> was 2.556. Likewise if we look at the variance components, we can see that the sum of the non-residual effect variances for <code>model_w_wm</code> equals the variance of <code>model_base_wm</code> (36.8). So this latest model allows us to disentangle the worker and machine effects, where our baseline models did not.</p>
<div class="layout-chunk" data-layout="l-body">

</div>
<p>Next we’ll do the ‘vector-valued’ model Bates describes. This removes the intercept portion of the formula in the original random slopes model, but is otherwise the same. We can look at the results here, but I will hold off description for comparing it to other models. Note that at least have no convergence problem.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
model_m_vv = lmer(score ~ Machine + (0 + Machine | Worker), machines)

summarize_model(model_m_vv, ci = 0, cor_re = TRUE)</code></pre>
<pre><code>
Variance Components:</code></pre>
<pre><code>
    Group   Effect Variance   SD Var_prop
   Worker MachineA    16.67 4.08     0.15
   Worker MachineB    74.30 8.62     0.67
   Worker MachineC    19.27 4.39     0.17
 Residual              0.93 0.96     0.01</code></pre>
<pre><code>
Correlation of Random Effects:</code></pre>
<pre><code>
         MachineA MachineB MachineC
MachineA     1.00     0.80     0.62
MachineB     0.80     1.00     0.77
MachineC     0.62     0.77     1.00</code></pre>
<pre><code>

Fixed Effects:</code></pre>
<pre><code>
      Term Value   SE     t P_value Lower_2.5 Upper_97.5
 Intercept 52.36 1.68 31.12    0.00     49.06      55.65
  MachineB  7.97 2.42  3.30    0.00      3.23      12.70
  MachineC 13.92 1.54  9.05    0.00     10.90      16.93</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">

</div>
<h3 id="summarize-all-the-models">Summarize All the Models</h3>
<p>Now let’s extract the fixed effect and variance component summaries for all the models.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
model_list = mget(ls(pattern = &#39;model_&#39;))

fe = map_df(model_list, extract_fixed_effects, .id = &#39;model&#39;)

vc = map_df(model_list, extract_vc, ci_level = 0, .id = &#39;model&#39;)</code></pre>
</div>
<p>First, let’s look at the fixed effects. We see that there are no differences in the coefficients for the fixed effect of machine, which is our only covariate in the model. However, there are notable differences for the estimated standard errors. Practically we’d come to no differences in our conclusions, but the uncertainty associated with them would be different.</p>
<div class="layout-chunk" data-layout="l-body">
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
model
</th>
<th style="text-align:left;">
term
</th>
<th style="text-align:right;">
value
</th>
<th style="text-align:right;">
se
</th>
<th style="text-align:right;">
t
</th>
<th style="text-align:right;">
p_value
</th>
<th style="text-align:right;">
lower_2.5
</th>
<th style="text-align:right;">
upper_97.5
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
model_base_w
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:right;">
52.356
</td>
<td style="text-align:right;">
2.229
</td>
<td style="text-align:right;">
23.485
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
47.986
</td>
<td style="text-align:right;">
56.725
</td>
</tr>
<tr>
<td style="text-align:left;">
model_base_w
</td>
<td style="text-align:left;">
MachineB
</td>
<td style="text-align:right;">
7.967
</td>
<td style="text-align:right;">
1.054
</td>
<td style="text-align:right;">
7.559
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
5.901
</td>
<td style="text-align:right;">
10.032
</td>
</tr>
<tr>
<td style="text-align:left;">
model_base_w
</td>
<td style="text-align:left;">
MachineC
</td>
<td style="text-align:right;">
13.917
</td>
<td style="text-align:right;">
1.054
</td>
<td style="text-align:right;">
13.205
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
11.851
</td>
<td style="text-align:right;">
15.982
</td>
</tr>
<tr>
<td style="text-align:left;">
model_base_wm
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:right;">
52.356
</td>
<td style="text-align:right;">
2.486
</td>
<td style="text-align:right;">
21.062
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
47.483
</td>
<td style="text-align:right;">
57.228
</td>
</tr>
<tr>
<td style="text-align:left;">
model_base_wm
</td>
<td style="text-align:left;">
MachineB
</td>
<td style="text-align:right;">
7.967
</td>
<td style="text-align:right;">
3.516
</td>
<td style="text-align:right;">
2.266
</td>
<td style="text-align:right;">
0.023
</td>
<td style="text-align:right;">
1.076
</td>
<td style="text-align:right;">
14.857
</td>
</tr>
<tr>
<td style="text-align:left;">
model_base_wm
</td>
<td style="text-align:left;">
MachineC
</td>
<td style="text-align:right;">
13.917
</td>
<td style="text-align:right;">
3.516
</td>
<td style="text-align:right;">
3.959
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
7.026
</td>
<td style="text-align:right;">
20.807
</td>
</tr>
<tr>
<td style="text-align:left;">
model_m_slope
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:right;">
52.356
</td>
<td style="text-align:right;">
1.683
</td>
<td style="text-align:right;">
31.116
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
49.058
</td>
<td style="text-align:right;">
55.653
</td>
</tr>
<tr>
<td style="text-align:left;">
model_m_slope
</td>
<td style="text-align:left;">
MachineB
</td>
<td style="text-align:right;">
7.967
</td>
<td style="text-align:right;">
2.427
</td>
<td style="text-align:right;">
3.283
</td>
<td style="text-align:right;">
0.001
</td>
<td style="text-align:right;">
3.210
</td>
<td style="text-align:right;">
12.723
</td>
</tr>
<tr>
<td style="text-align:left;">
model_m_slope
</td>
<td style="text-align:left;">
MachineC
</td>
<td style="text-align:right;">
13.917
</td>
<td style="text-align:right;">
1.541
</td>
<td style="text-align:right;">
9.033
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
10.897
</td>
<td style="text-align:right;">
16.936
</td>
</tr>
<tr>
<td style="text-align:left;">
model_m_vv
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:right;">
52.356
</td>
<td style="text-align:right;">
1.682
</td>
<td style="text-align:right;">
31.122
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
49.058
</td>
<td style="text-align:right;">
55.653
</td>
</tr>
<tr>
<td style="text-align:left;">
model_m_vv
</td>
<td style="text-align:left;">
MachineB
</td>
<td style="text-align:right;">
7.967
</td>
<td style="text-align:right;">
2.416
</td>
<td style="text-align:right;">
3.297
</td>
<td style="text-align:right;">
0.001
</td>
<td style="text-align:right;">
3.230
</td>
<td style="text-align:right;">
12.703
</td>
</tr>
<tr>
<td style="text-align:left;">
model_m_vv
</td>
<td style="text-align:left;">
MachineC
</td>
<td style="text-align:right;">
13.917
</td>
<td style="text-align:right;">
1.537
</td>
<td style="text-align:right;">
9.053
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
10.904
</td>
<td style="text-align:right;">
16.930
</td>
</tr>
<tr>
<td style="text-align:left;">
model_w_wm
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:right;">
52.356
</td>
<td style="text-align:right;">
2.486
</td>
<td style="text-align:right;">
21.062
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
47.483
</td>
<td style="text-align:right;">
57.228
</td>
</tr>
<tr>
<td style="text-align:left;">
model_w_wm
</td>
<td style="text-align:left;">
MachineB
</td>
<td style="text-align:right;">
7.967
</td>
<td style="text-align:right;">
2.177
</td>
<td style="text-align:right;">
3.660
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
3.700
</td>
<td style="text-align:right;">
12.233
</td>
</tr>
<tr>
<td style="text-align:left;">
model_w_wm
</td>
<td style="text-align:left;">
MachineC
</td>
<td style="text-align:right;">
13.917
</td>
<td style="text-align:right;">
2.177
</td>
<td style="text-align:right;">
6.393
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
9.650
</td>
<td style="text-align:right;">
18.183
</td>
</tr>
</tbody>
</table>
</div>
<p>Here are the variance components, there are definitely some differences here, but, as we’ll see, maybe not as much as we suspect.</p>
<div class="layout-chunk" data-layout="l-body">
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
model
</th>
<th style="text-align:left;">
group
</th>
<th style="text-align:left;">
effect
</th>
<th style="text-align:right;">
variance
</th>
<th style="text-align:right;">
sd
</th>
<th style="text-align:right;">
var_prop
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
model_base_w
</td>
<td style="text-align:left;">
Worker
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:right;">
26.487
</td>
<td style="text-align:right;">
5.147
</td>
<td style="text-align:right;">
0.726
</td>
</tr>
<tr>
<td style="text-align:left;">
model_base_w
</td>
<td style="text-align:left;">
Residual
</td>
<td style="text-align:left;">
</td>
<td style="text-align:right;">
9.996
</td>
<td style="text-align:right;">
3.162
</td>
<td style="text-align:right;">
0.274
</td>
</tr>
<tr>
<td style="text-align:left;">
model_base_wm
</td>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:right;">
36.768
</td>
<td style="text-align:right;">
6.064
</td>
<td style="text-align:right;">
0.975
</td>
</tr>
<tr>
<td style="text-align:left;">
model_base_wm
</td>
<td style="text-align:left;">
Residual
</td>
<td style="text-align:left;">
</td>
<td style="text-align:right;">
0.925
</td>
<td style="text-align:right;">
0.962
</td>
<td style="text-align:right;">
0.025
</td>
</tr>
<tr>
<td style="text-align:left;">
model_m_slope
</td>
<td style="text-align:left;">
Worker
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:right;">
16.679
</td>
<td style="text-align:right;">
4.084
</td>
<td style="text-align:right;">
0.253
</td>
</tr>
<tr>
<td style="text-align:left;">
model_m_slope
</td>
<td style="text-align:left;">
Worker
</td>
<td style="text-align:left;">
MachineB
</td>
<td style="text-align:right;">
34.717
</td>
<td style="text-align:right;">
5.892
</td>
<td style="text-align:right;">
0.526
</td>
</tr>
<tr>
<td style="text-align:left;">
model_m_slope
</td>
<td style="text-align:left;">
Worker
</td>
<td style="text-align:left;">
MachineC
</td>
<td style="text-align:right;">
13.625
</td>
<td style="text-align:right;">
3.691
</td>
<td style="text-align:right;">
0.207
</td>
</tr>
<tr>
<td style="text-align:left;">
model_m_slope
</td>
<td style="text-align:left;">
Residual
</td>
<td style="text-align:left;">
</td>
<td style="text-align:right;">
0.924
</td>
<td style="text-align:right;">
0.961
</td>
<td style="text-align:right;">
0.014
</td>
</tr>
<tr>
<td style="text-align:left;">
model_m_vv
</td>
<td style="text-align:left;">
Worker
</td>
<td style="text-align:left;">
MachineA
</td>
<td style="text-align:right;">
16.672
</td>
<td style="text-align:right;">
4.083
</td>
<td style="text-align:right;">
0.150
</td>
</tr>
<tr>
<td style="text-align:left;">
model_m_vv
</td>
<td style="text-align:left;">
Worker
</td>
<td style="text-align:left;">
MachineB
</td>
<td style="text-align:right;">
74.302
</td>
<td style="text-align:right;">
8.620
</td>
<td style="text-align:right;">
0.668
</td>
</tr>
<tr>
<td style="text-align:left;">
model_m_vv
</td>
<td style="text-align:left;">
Worker
</td>
<td style="text-align:left;">
MachineC
</td>
<td style="text-align:right;">
19.270
</td>
<td style="text-align:right;">
4.390
</td>
<td style="text-align:right;">
0.173
</td>
</tr>
<tr>
<td style="text-align:left;">
model_m_vv
</td>
<td style="text-align:left;">
Residual
</td>
<td style="text-align:left;">
</td>
<td style="text-align:right;">
0.925
</td>
<td style="text-align:right;">
0.962
</td>
<td style="text-align:right;">
0.008
</td>
</tr>
<tr>
<td style="text-align:left;">
model_w_wm
</td>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:right;">
13.909
</td>
<td style="text-align:right;">
3.730
</td>
<td style="text-align:right;">
0.369
</td>
</tr>
<tr>
<td style="text-align:left;">
model_w_wm
</td>
<td style="text-align:left;">
Worker
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:right;">
22.858
</td>
<td style="text-align:right;">
4.781
</td>
<td style="text-align:right;">
0.606
</td>
</tr>
<tr>
<td style="text-align:left;">
model_w_wm
</td>
<td style="text-align:left;">
Residual
</td>
<td style="text-align:left;">
</td>
<td style="text-align:right;">
0.925
</td>
<td style="text-align:right;">
0.962
</td>
<td style="text-align:right;">
0.025
</td>
</tr>
</tbody>
</table>
</div>
<p>We can see that the <code>base_wm</code> model has (non-residual) variance 36.768. This equals the total of the two (non-residual) variance components of the <code>w_wm</code> model 13.909 <code>+</code> 22.858, which again speaks to the latter model decomposing a machine effect into worker + machine effects. This value also equals the variance of the vector-valued model divided by the number of groups (16.672 + 74.302 + 19.27) <code>/</code> 3.</p>
<p>We can see that the estimated random effects from the vector-valued model (<code>m_vv</code>) are essentially the same as from the baseline, interaction-only model. However, the way it is estimated allows for incorporation of correlations among the machine random effects, so they are not identical (but pretty close).</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
extract_random_effects(model_m_vv)

extract_random_effects(model_base_wm) </code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
group_var
</th>
<th style="text-align:left;">
effect
</th>
<th style="text-align:left;">
group
</th>
<th style="text-align:right;">
value
</th>
<th style="text-align:right;">
se
</th>
<th style="text-align:right;">
lower_2.5
</th>
<th style="text-align:right;">
upper_97.5
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Worker
</td>
<td style="text-align:left;">
MachineA
</td>
<td style="text-align:left;">
1
</td>
<td style="text-align:right;">
0.312
</td>
<td style="text-align:right;">
0.541
</td>
<td style="text-align:right;">
-0.749
</td>
<td style="text-align:right;">
1.373
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker
</td>
<td style="text-align:left;">
MachineB
</td>
<td style="text-align:left;">
1
</td>
<td style="text-align:right;">
2.553
</td>
<td style="text-align:right;">
0.551
</td>
<td style="text-align:right;">
1.474
</td>
<td style="text-align:right;">
3.632
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker
</td>
<td style="text-align:left;">
MachineC
</td>
<td style="text-align:left;">
1
</td>
<td style="text-align:right;">
0.930
</td>
<td style="text-align:right;">
0.545
</td>
<td style="text-align:right;">
-0.137
</td>
<td style="text-align:right;">
1.998
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker
</td>
<td style="text-align:left;">
MachineA
</td>
<td style="text-align:left;">
2
</td>
<td style="text-align:right;">
0.183
</td>
<td style="text-align:right;">
0.541
</td>
<td style="text-align:right;">
-0.878
</td>
<td style="text-align:right;">
1.245
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker
</td>
<td style="text-align:left;">
MachineB
</td>
<td style="text-align:left;">
2
</td>
<td style="text-align:right;">
-0.803
</td>
<td style="text-align:right;">
0.551
</td>
<td style="text-align:right;">
-1.882
</td>
<td style="text-align:right;">
0.276
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker
</td>
<td style="text-align:left;">
MachineC
</td>
<td style="text-align:left;">
2
</td>
<td style="text-align:right;">
-4.282
</td>
<td style="text-align:right;">
0.545
</td>
<td style="text-align:right;">
-5.350
</td>
<td style="text-align:right;">
-3.214
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker
</td>
<td style="text-align:left;">
MachineA
</td>
<td style="text-align:left;">
3
</td>
<td style="text-align:right;">
6.969
</td>
<td style="text-align:right;">
0.541
</td>
<td style="text-align:right;">
5.908
</td>
<td style="text-align:right;">
8.031
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker
</td>
<td style="text-align:left;">
MachineB
</td>
<td style="text-align:left;">
3
</td>
<td style="text-align:right;">
7.779
</td>
<td style="text-align:right;">
0.551
</td>
<td style="text-align:right;">
6.700
</td>
<td style="text-align:right;">
8.858
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker
</td>
<td style="text-align:left;">
MachineC
</td>
<td style="text-align:left;">
3
</td>
<td style="text-align:right;">
4.474
</td>
<td style="text-align:right;">
0.545
</td>
<td style="text-align:right;">
3.406
</td>
<td style="text-align:right;">
5.542
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker
</td>
<td style="text-align:left;">
MachineA
</td>
<td style="text-align:left;">
4
</td>
<td style="text-align:right;">
-1.024
</td>
<td style="text-align:right;">
0.541
</td>
<td style="text-align:right;">
-2.085
</td>
<td style="text-align:right;">
0.037
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker
</td>
<td style="text-align:left;">
MachineB
</td>
<td style="text-align:left;">
4
</td>
<td style="text-align:right;">
2.328
</td>
<td style="text-align:right;">
0.551
</td>
<td style="text-align:right;">
1.249
</td>
<td style="text-align:right;">
3.408
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker
</td>
<td style="text-align:left;">
MachineC
</td>
<td style="text-align:left;">
4
</td>
<td style="text-align:right;">
-1.415
</td>
<td style="text-align:right;">
0.545
</td>
<td style="text-align:right;">
-2.482
</td>
<td style="text-align:right;">
-0.347
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker
</td>
<td style="text-align:left;">
MachineA
</td>
<td style="text-align:left;">
5
</td>
<td style="text-align:right;">
-0.849
</td>
<td style="text-align:right;">
0.541
</td>
<td style="text-align:right;">
-1.910
</td>
<td style="text-align:right;">
0.212
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker
</td>
<td style="text-align:left;">
MachineB
</td>
<td style="text-align:left;">
5
</td>
<td style="text-align:right;">
4.726
</td>
<td style="text-align:right;">
0.551
</td>
<td style="text-align:right;">
3.647
</td>
<td style="text-align:right;">
5.805
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker
</td>
<td style="text-align:left;">
MachineC
</td>
<td style="text-align:left;">
5
</td>
<td style="text-align:right;">
5.323
</td>
<td style="text-align:right;">
0.545
</td>
<td style="text-align:right;">
4.255
</td>
<td style="text-align:right;">
6.390
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker
</td>
<td style="text-align:left;">
MachineA
</td>
<td style="text-align:left;">
6
</td>
<td style="text-align:right;">
-5.592
</td>
<td style="text-align:right;">
0.541
</td>
<td style="text-align:right;">
-6.653
</td>
<td style="text-align:right;">
-4.531
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker
</td>
<td style="text-align:left;">
MachineB
</td>
<td style="text-align:left;">
6
</td>
<td style="text-align:right;">
-16.583
</td>
<td style="text-align:right;">
0.551
</td>
<td style="text-align:right;">
-17.662
</td>
<td style="text-align:right;">
-15.504
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker
</td>
<td style="text-align:left;">
MachineC
</td>
<td style="text-align:left;">
6
</td>
<td style="text-align:right;">
-5.030
</td>
<td style="text-align:right;">
0.545
</td>
<td style="text-align:right;">
-6.098
</td>
<td style="text-align:right;">
-3.963
</td>
</tr>
</tbody>
</table>
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
group_var
</th>
<th style="text-align:left;">
effect
</th>
<th style="text-align:left;">
group
</th>
<th style="text-align:right;">
value
</th>
<th style="text-align:right;">
se
</th>
<th style="text-align:right;">
lower_2.5
</th>
<th style="text-align:right;">
upper_97.5
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
1:A
</td>
<td style="text-align:right;">
0.275
</td>
<td style="text-align:right;">
0.553
</td>
<td style="text-align:right;">
-0.808
</td>
<td style="text-align:right;">
1.359
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
1:B
</td>
<td style="text-align:right;">
2.556
</td>
<td style="text-align:right;">
0.553
</td>
<td style="text-align:right;">
1.473
</td>
<td style="text-align:right;">
3.640
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
1:C
</td>
<td style="text-align:right;">
0.920
</td>
<td style="text-align:right;">
0.553
</td>
<td style="text-align:right;">
-0.164
</td>
<td style="text-align:right;">
2.004
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
2:A
</td>
<td style="text-align:right;">
0.209
</td>
<td style="text-align:right;">
0.553
</td>
<td style="text-align:right;">
-0.874
</td>
<td style="text-align:right;">
1.293
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
2:B
</td>
<td style="text-align:right;">
-0.749
</td>
<td style="text-align:right;">
0.553
</td>
<td style="text-align:right;">
-1.833
</td>
<td style="text-align:right;">
0.334
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
2:C
</td>
<td style="text-align:right;">
-4.402
</td>
<td style="text-align:right;">
0.553
</td>
<td style="text-align:right;">
-5.486
</td>
<td style="text-align:right;">
-3.318
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
3:A
</td>
<td style="text-align:right;">
7.118
</td>
<td style="text-align:right;">
0.553
</td>
<td style="text-align:right;">
6.035
</td>
<td style="text-align:right;">
8.202
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
3:B
</td>
<td style="text-align:right;">
7.647
</td>
<td style="text-align:right;">
0.553
</td>
<td style="text-align:right;">
6.563
</td>
<td style="text-align:right;">
8.731
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
3:C
</td>
<td style="text-align:right;">
4.490
</td>
<td style="text-align:right;">
0.553
</td>
<td style="text-align:right;">
3.407
</td>
<td style="text-align:right;">
5.574
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
4:A
</td>
<td style="text-align:right;">
-1.113
</td>
<td style="text-align:right;">
0.553
</td>
<td style="text-align:right;">
-2.196
</td>
<td style="text-align:right;">
-0.029
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
4:B
</td>
<td style="text-align:right;">
2.391
</td>
<td style="text-align:right;">
0.553
</td>
<td style="text-align:right;">
1.307
</td>
<td style="text-align:right;">
3.475
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
4:C
</td>
<td style="text-align:right;">
-1.493
</td>
<td style="text-align:right;">
0.553
</td>
<td style="text-align:right;">
-2.577
</td>
<td style="text-align:right;">
-0.409
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
5:A
</td>
<td style="text-align:right;">
-0.981
</td>
<td style="text-align:right;">
0.553
</td>
<td style="text-align:right;">
-2.064
</td>
<td style="text-align:right;">
0.103
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
5:B
</td>
<td style="text-align:right;">
4.705
</td>
<td style="text-align:right;">
0.553
</td>
<td style="text-align:right;">
3.621
</td>
<td style="text-align:right;">
5.789
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
5:C
</td>
<td style="text-align:right;">
5.416
</td>
<td style="text-align:right;">
0.553
</td>
<td style="text-align:right;">
4.332
</td>
<td style="text-align:right;">
6.499
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
6:A
</td>
<td style="text-align:right;">
-5.509
</td>
<td style="text-align:right;">
0.553
</td>
<td style="text-align:right;">
-6.593
</td>
<td style="text-align:right;">
-4.426
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
6:B
</td>
<td style="text-align:right;">
-16.550
</td>
<td style="text-align:right;">
0.553
</td>
<td style="text-align:right;">
-17.634
</td>
<td style="text-align:right;">
-15.467
</td>
</tr>
<tr>
<td style="text-align:left;">
Worker:Machine
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:left;">
6:C
</td>
<td style="text-align:right;">
-4.931
</td>
<td style="text-align:right;">
0.553
</td>
<td style="text-align:right;">
-6.014
</td>
<td style="text-align:right;">
-3.847
</td>
</tr>
</tbody>
</table>
</div>
<p>Even the default way that the extracted random effects are structured implies this difference. In the vector-valued model we have a multivariate normal draw for 3 machines (i.e. 3 variances and 3 covariances) for each of six workers. In the baseline model, we do not estimate any covariances and assume equal variance to draw for 18 groups (1 variance).</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
ranef(model_m_vv)</code></pre>
<pre><code>
$Worker
    MachineA    MachineB   MachineC
1  0.3121470   2.5531279  0.9302595
2  0.1833294  -0.8032619 -4.2820004
3  6.9694168   7.7792265  4.4740418
4 -1.0238949   2.3283434 -1.4146891
5 -0.8487803   4.7258593  5.3227211
6 -5.5922179 -16.5832953 -5.0303328

with conditional variances for &quot;Worker&quot; </code></pre>
<pre class="r"><code>
ranef(model_base_wm)</code></pre>
<pre><code>
$`Worker:Machine`
    (Intercept)
1:A   0.2754687
1:B   2.5563491
1:C   0.9200653
2:A   0.2093562
2:B  -0.7492747
2:C  -4.4019891
3:A   7.1181101
3:B   7.6470099
3:C   4.4901391
4:A  -1.1128934
4:B   2.3910679
4:C  -1.4930401
5:A  -0.9806684
5:B   4.7050047
5:C   5.4157138
6:A  -5.5093731
6:B -16.5501569
6:C  -4.9308890

with conditional variances for &quot;Worker:Machine&quot; </code></pre>
</div>
<p>Now let’s compare the models directly via AIC. As we would expect if we dummy coded a predictor vs. running a model without the intercept (e.g. <code>lm(score ~ machine)</code>, vs. <code>lm(score ~ -1 + machine)</code>), the random slope model and vector-valued models are identical and produce the same AIC. Likewise the intercept variance of the former is equal to the first group variance of the vector-valued model.</p>
<div class="layout-chunk" data-layout="l-body">
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:right;">
model_base_w
</th>
<th style="text-align:right;">
model_base_wm
</th>
<th style="text-align:right;">
model_m_slope
</th>
<th style="text-align:right;">
model_m_vv
</th>
<th style="text-align:right;">
model_w_wm
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
296.878
</td>
<td style="text-align:right;">
231.256
</td>
<td style="text-align:right;">
228.311
</td>
<td style="text-align:right;">
228.311
</td>
<td style="text-align:right;">
227.688
</td>
</tr>
</tbody>
</table>
</div>
<p>While such a model is doing better than either of our baseline models, it turns out that our other approach is slightly better, as the additional complexity of estimating the covariances and separate variances wasn’t really worth it.</p>
<p>At this point we’ve seen a couple of ways of doing a model in this situation. Some may be a little too simplistic for a given scenario, others may not capture the correlation structure the way we’d want. In any case, we have options to explore.</p>
<!-- https://github.com/m-clark/Visuals/tree/master/random_effects -->
<h2 id="simulation">Simulation</h2>
<p>The following is a simplified approach to creating data in this scenario, and allows us to play around with the settings to see what happens.</p>
<h3 id="data-creation">Data Creation</h3>
<p>First we need some data. The following creates a group identifier similar to <code>Worker</code> in our previous example, a <code>cat_var</code> like our <code>Machine</code>, and other covariates just to make it interesting.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
# for simplicity keeping to 3 cat levels
set.seed(1234)
ng = 5000     # n groups
cat_levs = 3  # n levels per group
reps = 4      # number of obs per level per cat

id = rep(1:ng, each = cat_levs * reps)           # id indicator (e.g. like Worker)
cat_var = rep(1:cat_levs, times = ng, e = reps)  # categorical variable (e.g. Machine)
x = rnorm(ng * cat_levs * reps)                  # continuous covariate
x_c = rep(rnorm(ng), e = cat_levs * reps)        # continuous cluster level covariate</code></pre>
</div>
<p>So we have the basic data in place, now we need to create the random effects. There are several ways we could do this, including more efficient ones, but this approach focuses on a conceptual approach and on the model that got us here, i.e. something of the form <code>(1 + cat_var | group)</code>. In this case we assume this model is ‘correct’, so we’re going to create a multivariate normal draw of random effects for each level of the <code>cat_var</code>, which is only 3 levels. The correlations depicted are the estimates we expect from our model for the random effects<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
# as correlated  (1, .5, .5) var, (1, .25, .25) sd 
cov_mat = lazerhawk::create_corr(c(.1, .25, .25), diagonal = c(1, .5, .5))

cov2cor(cov_mat)  # these will be the estimated correlations for the random_slope model</code></pre>
<pre><code>
          [,1]      [,2]      [,3]
[1,] 1.0000000 0.1414214 0.3535534
[2,] 0.1414214 1.0000000 0.5000000
[3,] 0.3535534 0.5000000 1.0000000</code></pre>
</div>
<p>Now we create the random effects by drawing an effect for each categorical level for each group.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
# take a multivariate normal draw for each of the groups in `id`
re_id_cat_lev = mvtnorm::rmvnorm(ng, mean = rep(0, 3), sigma = cov_mat) %&gt;% 
  data.frame()

head(re_id_cat_lev)</code></pre>
<pre><code>
          X1          X2          X3
1  0.5618465  0.62780841  1.15175459
2  0.6588685  0.78045939  0.25942427
3  0.2680315 -0.06403496  1.30173301
4 -0.3711184  0.37579392 -0.03242486
5 -1.1306064 -0.08450038 -0.38165685
6 -0.7537223  0.65320469  0.33269260</code></pre>
</div>
<p>Now that we have the random effects, we can create our target variable. We do this by adding our first effect to the intercept, and the others to their respective coefficients.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
y = 
  # fixed effect = (2, .5, -.5)
  2  + .5*x - .5*x_c +   
  # random intercept
  rep(re_id_cat_lev[, 1], each = cat_levs * reps) +                           
  # .25 is the fixef for group 2 vs. 1
  (.25 + rep(re_id_cat_lev[, 2], each = cat_levs * reps)) * (cat_var == 2) +  
  # .40 is the fixef for group 3 vs. 1
  (.40 + rep(re_id_cat_lev[, 3], each = cat_levs * reps)) * (cat_var == 3) +  
  rnorm(ng * cat_levs * reps, sd = .5)</code></pre>
</div>
<p>Now we create a data frame so we can see everything together.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
df = tibble(
    id,
    cat_var,
    x,
    x_c,
    y,
    re_id = rep(re_id_cat_lev[, 1], each = cat_levs*reps),
    re_id_cat_lev2 = rep(re_id_cat_lev[, 2], each = cat_levs*reps),
    re_id_cat_lev3 = rep(re_id_cat_lev[, 3], each = cat_levs*reps)
  ) %&gt;% 
  mutate(
    cat_var = factor(cat_var),
    cat_as_num = as.integer(cat_var),
    id = factor(id)
  )

df %&gt;% print(n = 30)</code></pre>
<pre><code>
# A tibble: 60,000 x 9
   id    cat_var       x    x_c     y re_id re_id_cat_lev2 re_id_cat_lev3 cat_as_num
   &lt;fct&gt; &lt;fct&gt;     &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;          &lt;dbl&gt;          &lt;dbl&gt;      &lt;int&gt;
 1 1     1       -1.21   -1.43  3.04  0.562         0.628           1.15           1
 2 1     1        0.277  -1.43  3.35  0.562         0.628           1.15           1
 3 1     1        1.08   -1.43  3.46  0.562         0.628           1.15           1
 4 1     1       -2.35   -1.43  2.64  0.562         0.628           1.15           1
 5 1     2        0.429  -1.43  4.59  0.562         0.628           1.15           2
 6 1     2        0.506  -1.43  3.61  0.562         0.628           1.15           2
 7 1     2       -0.575  -1.43  3.54  0.562         0.628           1.15           2
 8 1     2       -0.547  -1.43  2.98  0.562         0.628           1.15           2
 9 1     3       -0.564  -1.43  5.28  0.562         0.628           1.15           3
10 1     3       -0.890  -1.43  4.06  0.562         0.628           1.15           3
11 1     3       -0.477  -1.43  4.31  0.562         0.628           1.15           3
12 1     3       -0.998  -1.43  4.70  0.562         0.628           1.15           3
13 2     1       -0.776   0.126 2.25  0.659         0.780           0.259          1
14 2     1        0.0645  0.126 2.48  0.659         0.780           0.259          1
15 2     1        0.959   0.126 2.99  0.659         0.780           0.259          1
16 2     1       -0.110   0.126 2.55  0.659         0.780           0.259          1
17 2     2       -0.511   0.126 3.94  0.659         0.780           0.259          2
18 2     2       -0.911   0.126 3.22  0.659         0.780           0.259          2
19 2     2       -0.837   0.126 3.98  0.659         0.780           0.259          2
20 2     2        2.42    0.126 4.59  0.659         0.780           0.259          2
21 2     3        0.134   0.126 3.58  0.659         0.780           0.259          3
22 2     3       -0.491   0.126 3.31  0.659         0.780           0.259          3
23 2     3       -0.441   0.126 2.66  0.659         0.780           0.259          3
24 2     3        0.460   0.126 3.42  0.659         0.780           0.259          3
25 3     1       -0.694   0.437 0.985 0.268        -0.0640          1.30           1
26 3     1       -1.45    0.437 2.08  0.268        -0.0640          1.30           1
27 3     1        0.575   0.437 2.62  0.268        -0.0640          1.30           1
28 3     1       -1.02    0.437 1.24  0.268        -0.0640          1.30           1
29 3     2       -0.0151  0.437 2.24  0.268        -0.0640          1.30           2
30 3     2       -0.936   0.437 2.57  0.268        -0.0640          1.30           2
# … with 5.997e+04 more rows</code></pre>
</div>
<h3 id="run-the-models-summarize">Run the Models &amp; Summarize</h3>
<p>With everything in place, let’s run four models similar to our previous models from the Machine example:</p>
<ol type="1">
<li>The baseline model that does not distinguish the id from cat_var variance.</li>
<li>The random slope approach (data generating model)</li>
<li>The vector valued model (equivalent to #2)</li>
<li>The scalar model that does not estimate the random effect correlations</li>
</ol>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
m_interaction_only = lmer(y ~ x + x_c + cat_var + (1 | id:cat_var), df)
m_random_slope = lmer(y ~ x + x_c + cat_var + (1 + cat_var | id), df)    
m_vector_valued = lmer(y ~ x + x_c + cat_var + (0 + cat_var | id), df)
m_separate_re = lmer(y ~ x + x_c + cat_var + (1 | id) + (1 | id:cat_var), df)</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
model_mixed = list(
  m_interaction_only = m_interaction_only,
  m_random_slope = m_random_slope,
  m_vector_valued = m_vector_valued,
  m_separate_re = m_separate_re
)

# model summaries if desired
# map(model_mixed, summarize_model, ci = 0, cor_re = TRUE)
fe = map_df(model_mixed, extract_fixed_effects, .id = &#39;model&#39;) 
vc = map_df(model_mixed, extract_vc, ci_level = 0, .id = &#39;model&#39;)</code></pre>
</div>
<p>Looking at the fixed effects, we get what we should but, as before, we do see differences in the standard errors.</p>
<div class="layout-chunk" data-layout="l-body">
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
model
</th>
<th style="text-align:left;">
term
</th>
<th style="text-align:right;">
value
</th>
<th style="text-align:right;">
se
</th>
<th style="text-align:right;">
t
</th>
<th style="text-align:right;">
p_value
</th>
<th style="text-align:right;">
lower_2.5
</th>
<th style="text-align:right;">
upper_97.5
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
m_interaction_only
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:right;">
2.006
</td>
<td style="text-align:right;">
0.018
</td>
<td style="text-align:right;">
111.051
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1.971
</td>
<td style="text-align:right;">
2.042
</td>
</tr>
<tr>
<td style="text-align:left;">
m_interaction_only
</td>
<td style="text-align:left;">
x
</td>
<td style="text-align:right;">
0.497
</td>
<td style="text-align:right;">
0.002
</td>
<td style="text-align:right;">
212.962
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.492
</td>
<td style="text-align:right;">
0.501
</td>
</tr>
<tr>
<td style="text-align:left;">
m_interaction_only
</td>
<td style="text-align:left;">
x_c
</td>
<td style="text-align:right;">
-0.489
</td>
<td style="text-align:right;">
0.010
</td>
<td style="text-align:right;">
-46.776
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
-0.509
</td>
<td style="text-align:right;">
-0.469
</td>
</tr>
<tr>
<td style="text-align:left;">
m_interaction_only
</td>
<td style="text-align:left;">
cat_var2
</td>
<td style="text-align:right;">
0.256
</td>
<td style="text-align:right;">
0.026
</td>
<td style="text-align:right;">
10.026
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.206
</td>
<td style="text-align:right;">
0.306
</td>
</tr>
<tr>
<td style="text-align:left;">
m_interaction_only
</td>
<td style="text-align:left;">
cat_var3
</td>
<td style="text-align:right;">
0.389
</td>
<td style="text-align:right;">
0.026
</td>
<td style="text-align:right;">
15.228
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.339
</td>
<td style="text-align:right;">
0.439
</td>
</tr>
<tr>
<td style="text-align:left;">
m_random_slope
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:right;">
2.006
</td>
<td style="text-align:right;">
0.015
</td>
<td style="text-align:right;">
136.942
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1.977
</td>
<td style="text-align:right;">
2.035
</td>
</tr>
<tr>
<td style="text-align:left;">
m_random_slope
</td>
<td style="text-align:left;">
x
</td>
<td style="text-align:right;">
0.497
</td>
<td style="text-align:right;">
0.002
</td>
<td style="text-align:right;">
217.676
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.493
</td>
<td style="text-align:right;">
0.502
</td>
</tr>
<tr>
<td style="text-align:left;">
m_random_slope
</td>
<td style="text-align:left;">
x_c
</td>
<td style="text-align:right;">
-0.495
</td>
<td style="text-align:right;">
0.014
</td>
<td style="text-align:right;">
-34.636
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
-0.523
</td>
<td style="text-align:right;">
-0.467
</td>
</tr>
<tr>
<td style="text-align:left;">
m_random_slope
</td>
<td style="text-align:left;">
cat_var2
</td>
<td style="text-align:right;">
0.256
</td>
<td style="text-align:right;">
0.011
</td>
<td style="text-align:right;">
23.038
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.234
</td>
<td style="text-align:right;">
0.278
</td>
</tr>
<tr>
<td style="text-align:left;">
m_random_slope
</td>
<td style="text-align:left;">
cat_var3
</td>
<td style="text-align:right;">
0.389
</td>
<td style="text-align:right;">
0.011
</td>
<td style="text-align:right;">
34.969
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.367
</td>
<td style="text-align:right;">
0.411
</td>
</tr>
<tr>
<td style="text-align:left;">
m_vector_valued
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:right;">
2.006
</td>
<td style="text-align:right;">
0.015
</td>
<td style="text-align:right;">
136.944
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1.977
</td>
<td style="text-align:right;">
2.035
</td>
</tr>
<tr>
<td style="text-align:left;">
m_vector_valued
</td>
<td style="text-align:left;">
x
</td>
<td style="text-align:right;">
0.497
</td>
<td style="text-align:right;">
0.002
</td>
<td style="text-align:right;">
217.676
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.493
</td>
<td style="text-align:right;">
0.502
</td>
</tr>
<tr>
<td style="text-align:left;">
m_vector_valued
</td>
<td style="text-align:left;">
x_c
</td>
<td style="text-align:right;">
-0.495
</td>
<td style="text-align:right;">
0.014
</td>
<td style="text-align:right;">
-34.636
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
-0.523
</td>
<td style="text-align:right;">
-0.467
</td>
</tr>
<tr>
<td style="text-align:left;">
m_vector_valued
</td>
<td style="text-align:left;">
cat_var2
</td>
<td style="text-align:right;">
0.256
</td>
<td style="text-align:right;">
0.011
</td>
<td style="text-align:right;">
23.038
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.234
</td>
<td style="text-align:right;">
0.278
</td>
</tr>
<tr>
<td style="text-align:left;">
m_vector_valued
</td>
<td style="text-align:left;">
cat_var3
</td>
<td style="text-align:right;">
0.389
</td>
<td style="text-align:right;">
0.011
</td>
<td style="text-align:right;">
34.969
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.367
</td>
<td style="text-align:right;">
0.411
</td>
</tr>
<tr>
<td style="text-align:left;">
m_separate_re
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:right;">
2.006
</td>
<td style="text-align:right;">
0.018
</td>
<td style="text-align:right;">
111.045
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1.971
</td>
<td style="text-align:right;">
2.042
</td>
</tr>
<tr>
<td style="text-align:left;">
m_separate_re
</td>
<td style="text-align:left;">
x
</td>
<td style="text-align:right;">
0.497
</td>
<td style="text-align:right;">
0.002
</td>
<td style="text-align:right;">
216.586
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.493
</td>
<td style="text-align:right;">
0.502
</td>
</tr>
<tr>
<td style="text-align:left;">
m_separate_re
</td>
<td style="text-align:left;">
x_c
</td>
<td style="text-align:right;">
-0.489
</td>
<td style="text-align:right;">
0.017
</td>
<td style="text-align:right;">
-28.883
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
-0.522
</td>
<td style="text-align:right;">
-0.456
</td>
</tr>
<tr>
<td style="text-align:left;">
m_separate_re
</td>
<td style="text-align:left;">
cat_var2
</td>
<td style="text-align:right;">
0.256
</td>
<td style="text-align:right;">
0.011
</td>
<td style="text-align:right;">
23.077
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.234
</td>
<td style="text-align:right;">
0.278
</td>
</tr>
<tr>
<td style="text-align:left;">
m_separate_re
</td>
<td style="text-align:left;">
cat_var3
</td>
<td style="text-align:right;">
0.389
</td>
<td style="text-align:right;">
0.011
</td>
<td style="text-align:right;">
35.050
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.367
</td>
<td style="text-align:right;">
0.411
</td>
</tr>
</tbody>
</table>
</div>
<p>The variance components break down as before.</p>
<div class="layout-chunk" data-layout="l-body">
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
model
</th>
<th style="text-align:left;">
group
</th>
<th style="text-align:left;">
effect
</th>
<th style="text-align:right;">
variance
</th>
<th style="text-align:right;">
sd
</th>
<th style="text-align:right;">
var_prop
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
m_interaction_only
</td>
<td style="text-align:left;">
id:cat_var
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:right;">
1.570
</td>
<td style="text-align:right;">
1.253
</td>
<td style="text-align:right;">
0.864
</td>
</tr>
<tr>
<td style="text-align:left;">
m_interaction_only
</td>
<td style="text-align:left;">
Residual
</td>
<td style="text-align:left;">
</td>
<td style="text-align:right;">
0.247
</td>
<td style="text-align:right;">
0.497
</td>
<td style="text-align:right;">
0.136
</td>
</tr>
<tr>
<td style="text-align:left;">
m_random_slope
</td>
<td style="text-align:left;">
id
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:right;">
1.011
</td>
<td style="text-align:right;">
1.006
</td>
<td style="text-align:right;">
0.450
</td>
</tr>
<tr>
<td style="text-align:left;">
m_random_slope
</td>
<td style="text-align:left;">
id
</td>
<td style="text-align:left;">
cat_var2
</td>
<td style="text-align:right;">
0.494
</td>
<td style="text-align:right;">
0.703
</td>
<td style="text-align:right;">
0.220
</td>
</tr>
<tr>
<td style="text-align:left;">
m_random_slope
</td>
<td style="text-align:left;">
id
</td>
<td style="text-align:left;">
cat_var3
</td>
<td style="text-align:right;">
0.495
</td>
<td style="text-align:right;">
0.704
</td>
<td style="text-align:right;">
0.220
</td>
</tr>
<tr>
<td style="text-align:left;">
m_random_slope
</td>
<td style="text-align:left;">
Residual
</td>
<td style="text-align:left;">
</td>
<td style="text-align:right;">
0.247
</td>
<td style="text-align:right;">
0.497
</td>
<td style="text-align:right;">
0.110
</td>
</tr>
<tr>
<td style="text-align:left;">
m_vector_valued
</td>
<td style="text-align:left;">
id
</td>
<td style="text-align:left;">
cat_var1
</td>
<td style="text-align:right;">
1.011
</td>
<td style="text-align:right;">
1.006
</td>
<td style="text-align:right;">
0.204
</td>
</tr>
<tr>
<td style="text-align:left;">
m_vector_valued
</td>
<td style="text-align:left;">
id
</td>
<td style="text-align:left;">
cat_var2
</td>
<td style="text-align:right;">
1.709
</td>
<td style="text-align:right;">
1.307
</td>
<td style="text-align:right;">
0.345
</td>
</tr>
<tr>
<td style="text-align:left;">
m_vector_valued
</td>
<td style="text-align:left;">
id
</td>
<td style="text-align:left;">
cat_var3
</td>
<td style="text-align:right;">
1.990
</td>
<td style="text-align:right;">
1.411
</td>
<td style="text-align:right;">
0.401
</td>
</tr>
<tr>
<td style="text-align:left;">
m_vector_valued
</td>
<td style="text-align:left;">
Residual
</td>
<td style="text-align:left;">
</td>
<td style="text-align:right;">
0.247
</td>
<td style="text-align:right;">
0.497
</td>
<td style="text-align:right;">
0.050
</td>
</tr>
<tr>
<td style="text-align:left;">
m_separate_re
</td>
<td style="text-align:left;">
id:cat_var
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:right;">
0.246
</td>
<td style="text-align:right;">
0.496
</td>
<td style="text-align:right;">
0.135
</td>
</tr>
<tr>
<td style="text-align:left;">
m_separate_re
</td>
<td style="text-align:left;">
id
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:right;">
1.324
</td>
<td style="text-align:right;">
1.151
</td>
<td style="text-align:right;">
0.728
</td>
</tr>
<tr>
<td style="text-align:left;">
m_separate_re
</td>
<td style="text-align:left;">
Residual
</td>
<td style="text-align:left;">
</td>
<td style="text-align:right;">
0.247
</td>
<td style="text-align:right;">
0.497
</td>
<td style="text-align:right;">
0.136
</td>
</tr>
</tbody>
</table>
</div>
<p>In this case, we know the model with correlated random effects is the more accurate model, and this is born out via AIC.</p>
<div class="layout-chunk" data-layout="l-body">
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:right;">
m_interaction_only
</th>
<th style="text-align:right;">
m_random_slope
</th>
<th style="text-align:right;">
m_vector_valued
</th>
<th style="text-align:right;">
m_separate_re
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
135592.8
</td>
<td style="text-align:right;">
122051.9
</td>
<td style="text-align:right;">
122051.9
</td>
<td style="text-align:right;">
123745.2
</td>
</tr>
</tbody>
</table>
</div>
<h3 id="change-the-model-orientation">Change the model orientation</h3>
<p>Now I will make the <code>vector_valued</code> model reduce to the <code>separate_re</code> model. First, we create a covariance matrix that has equal variances/covariances (i.e. compound symmetry), and for demonstration, we will apply the random effects a little differently. So, when we create the target variable, we make a slight alteration to apply it to the vector valued model instead.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
set.seed(1234)

cov_mat = lazerhawk::create_corr(c(0.1, 0.1, 0.1), diagonal = c(.5, .5, .5))

cov2cor(cov_mat)  # these will now be the estimated correlations for the vector_valued model</code></pre>
<pre><code>
     [,1] [,2] [,3]
[1,]  1.0  0.2  0.2
[2,]  0.2  1.0  0.2
[3,]  0.2  0.2  1.0</code></pre>
<pre class="r"><code>
re_id_cat_lev = mvtnorm::rmvnorm(ng, mean = rep(0, 3), sigma = cov_mat) %&gt;% 
  data.frame()

y = 2  + .5*x - .5*x_c +   # fixed effect = (2, .5, -.5)
  rep(re_id_cat_lev[, 1], each = cat_levs * reps) * (cat_var == 1) +     # added this
  rep(re_id_cat_lev[, 2], each = cat_levs * reps) * (cat_var == 2) +
  rep(re_id_cat_lev[, 3], each = cat_levs * reps) * (cat_var == 3) +
  .25 * (cat_var == 2) +  # .25 is the fixef for group 2 vs. 1
  .40 * (cat_var == 3) +  # .40 is the fixef for group 3 vs. 1
  rnorm(ng * cat_levs * reps, sd = .5)


df = tibble(
    id,
    cat_var  = factor(cat_var),
    x,
    x_c,
    y
  )</code></pre>
</div>
<p>Rerun the models.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
m_random_slope = lmer(y ~ x + x_c + cat_var + (1 + cat_var | id), df)  # still problems!
m_vector_valued = lmer(y ~ x + x_c + cat_var + (0 + cat_var | id), df)   
m_separate_re = lmer(y ~ x + x_c + cat_var + (1 | id) + (1 | id:cat_var), df)</code></pre>
</div>
<p>Examine the variance components.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
model_mixed = list(
  m_random_slope = m_random_slope,
  m_vector_valued = m_vector_valued,
  m_separate_re = m_separate_re
)

# model summaries if desired
# map(model_mixed, summarize_model, ci = 0, cor_re = TRUE)

# fixed effects if desired
# fe = map_df(model_mixed, extract_fixed_effects, .id = &#39;model&#39;)

vc = map_df(model_mixed, extract_vc, ci_level = 0, .id = &#39;model&#39;)</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
model
</th>
<th style="text-align:left;">
group
</th>
<th style="text-align:left;">
effect
</th>
<th style="text-align:right;">
variance
</th>
<th style="text-align:right;">
sd
</th>
<th style="text-align:right;">
var_prop
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
m_random_slope
</td>
<td style="text-align:left;">
id
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:right;">
0.491
</td>
<td style="text-align:right;">
0.700
</td>
<td style="text-align:right;">
0.213
</td>
</tr>
<tr>
<td style="text-align:left;">
m_random_slope
</td>
<td style="text-align:left;">
id
</td>
<td style="text-align:left;">
cat_var2
</td>
<td style="text-align:right;">
0.786
</td>
<td style="text-align:right;">
0.886
</td>
<td style="text-align:right;">
0.341
</td>
</tr>
<tr>
<td style="text-align:left;">
m_random_slope
</td>
<td style="text-align:left;">
id
</td>
<td style="text-align:left;">
cat_var3
</td>
<td style="text-align:right;">
0.778
</td>
<td style="text-align:right;">
0.882
</td>
<td style="text-align:right;">
0.337
</td>
</tr>
<tr>
<td style="text-align:left;">
m_random_slope
</td>
<td style="text-align:left;">
Residual
</td>
<td style="text-align:left;">
</td>
<td style="text-align:right;">
0.251
</td>
<td style="text-align:right;">
0.501
</td>
<td style="text-align:right;">
0.109
</td>
</tr>
<tr>
<td style="text-align:left;">
m_vector_valued
</td>
<td style="text-align:left;">
id
</td>
<td style="text-align:left;">
cat_var1
</td>
<td style="text-align:right;">
0.491
</td>
<td style="text-align:right;">
0.700
</td>
<td style="text-align:right;">
0.283
</td>
</tr>
<tr>
<td style="text-align:left;">
m_vector_valued
</td>
<td style="text-align:left;">
id
</td>
<td style="text-align:left;">
cat_var2
</td>
<td style="text-align:right;">
0.497
</td>
<td style="text-align:right;">
0.705
</td>
<td style="text-align:right;">
0.287
</td>
</tr>
<tr>
<td style="text-align:left;">
m_vector_valued
</td>
<td style="text-align:left;">
id
</td>
<td style="text-align:left;">
cat_var3
</td>
<td style="text-align:right;">
0.492
</td>
<td style="text-align:right;">
0.702
</td>
<td style="text-align:right;">
0.284
</td>
</tr>
<tr>
<td style="text-align:left;">
m_vector_valued
</td>
<td style="text-align:left;">
Residual
</td>
<td style="text-align:left;">
</td>
<td style="text-align:right;">
0.251
</td>
<td style="text-align:right;">
0.501
</td>
<td style="text-align:right;">
0.145
</td>
</tr>
<tr>
<td style="text-align:left;">
m_separate_re
</td>
<td style="text-align:left;">
id:cat_var
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:right;">
0.395
</td>
<td style="text-align:right;">
0.628
</td>
<td style="text-align:right;">
0.530
</td>
</tr>
<tr>
<td style="text-align:left;">
m_separate_re
</td>
<td style="text-align:left;">
id
</td>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:right;">
0.099
</td>
<td style="text-align:right;">
0.314
</td>
<td style="text-align:right;">
0.133
</td>
</tr>
<tr>
<td style="text-align:left;">
m_separate_re
</td>
<td style="text-align:left;">
Residual
</td>
<td style="text-align:left;">
</td>
<td style="text-align:right;">
0.251
</td>
<td style="text-align:right;">
0.501
</td>
<td style="text-align:right;">
0.337
</td>
</tr>
</tbody>
</table>
</div>
<p>In this case, we know the true case regards zero correlations and equal variances, so estimating them is adding complexity we don’t need, thus our simpler model wins (log likelihoods are essentially the same).</p>
<div class="layout-chunk" data-layout="l-body">
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
parameter
</th>
<th style="text-align:right;">
m_random_slope
</th>
<th style="text-align:right;">
m_vector_valued
</th>
<th style="text-align:right;">
m_separate_re
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
LL
</td>
<td style="text-align:right;">
-59818.9
</td>
<td style="text-align:right;">
-59818.9
</td>
<td style="text-align:right;">
-59819.72
</td>
</tr>
<tr>
<td style="text-align:left;">
AIC
</td>
<td style="text-align:right;">
119661.8
</td>
<td style="text-align:right;">
119661.8
</td>
<td style="text-align:right;">
119655.45
</td>
</tr>
</tbody>
</table>
</div>
<h2 id="summary">Summary</h2>
<p>Here we’ve demonstrated a couple of different ways to specify a particular model with random slopes for a categorical covariate. Intuition may lead to a model that is not easy to estimate, often leading to convergence problems. Sometimes, this model may be overly complicated, and a simpler version will likely have less estimation difficulty. Try it out if you run into trouble!</p>
<section class="footnotes" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p>Though I use the word ‘within’, do not take it to mean we have nested data.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p>I use a personal package to create the matrix where I can just specify the lower diagonal, as this comes up a lot for simulation. Feel free to just create the matrix directly given it’s just a 3x3.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
<!--radix_placeholder_article_footer-->
<!--/radix_placeholder_article_footer-->
</div>

<div class="d-appendix">
</div>


<!--radix_placeholder_site_after_body-->
<!--/radix_placeholder_site_after_body-->
<!--radix_placeholder_appendices-->
<div class="appendix-bottom"></div>
<!--/radix_placeholder_appendices-->
<!--radix_placeholder_navigation_after_body-->
<!--/radix_placeholder_navigation_after_body-->

</body>

</html>
